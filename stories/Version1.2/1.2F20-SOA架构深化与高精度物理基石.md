# **研发日志 1.2F20：服务化架构深化与高精度物理基石**

大家好，  
欢迎来到 1.2F20。继 1.2F3 版本确立了“服务化架构”这一里程碑后，我们在本版本中并没有急于堆砌新玩法。  
我们对服务架构进行了更深层次的优化，重新审视了租约系统的设计难题，并为物理引擎铺设了更精准的基石。

## **一、ServerWorldEventBus：从工具人到正规军**

在 1.2F3 中，我们定义了 SequenceUpdate 接口，试图让所有驱动世界的逻辑都标准化。然而，当时的 ServerWorldEventBus (服务端事件总线) 处境略显尴尬——它虽然干着核心的工作，却像个游离在编制外的“工具人”。  
在 1.2F20 中，我们正式将 ServerWorldEventBus 晋升为一项标准的 Service。  
现在的接口继承关系是：  
ServerWorldEventBus \-\> WorldEventBus \-\> SequenceUpdate  
这意味着事件总线现在拥有了一个标准的 action(double delta, SharedWorld world) 函数（在旧时代这通常被称为 process()）。它不再需要 ServerWorld 手动去“拉取”或“触发”，而是作为世界循环中不可或缺的一环，被 ServerWorld 自动调度执行。这让事件分发的时序更加可控，也让代码结构更加统一。

## **二、全局视野：GlobalService 接口**

随着服务化改造的深入，我们发现并非所有的服务都应该围着某一个“世界”转。  
有些服务是凌驾于世界之上的，比如负责读写磁盘归档的 ArchiveService。  
为了在架构上明确区分“世界级服务”与“引擎级服务”，我们推出了 **GlobalService** 接口。

* **特性**：全局服务是多世界共享的单例。  
* **区别**：与世界服务不同，GlobalService **不会** 被插入到 ServerWorld 的 Action 循环中。它们独立运行，不受单一世界的时间流逝或卡顿影响。

这解决了逻辑上的歧义：归档服务不应该因为某个世界的 TPS 降低而变慢，它应当始终保持独立且高效。

## **三、Flex 租约系统：视口概念与 TTL 的设计反转**

关于大家最关心的 Flex 区块实装进度，我想坦诚地聊聊我们在 **租约系统 (Lease System)** 上遇到的挑战。  
在 1.2F2 中我们引入了租约，但随着开发的深入，我们发现其设计难度远超预期。如何高效地判断哪些区块需要被“续租”？如何处理玩家快速移动带来的租约抖动？我们还必须面对一个棘手的**并发问题**：因为现在的架构中，网络线程（虚拟线程）也有权在玩家登录或传送时直接签发租约，而主线程也在同时处理过期逻辑，这不仅仅是业务逻辑的问题，更是一场关于**多线程并发**的恶战。

### **1\. 引入 ChunkViewPort (视口)**

为了解决“谁需要什么区块”的问题，我们引入了 **ChunkViewPort** 类。它抽象了观察者的视野范围，能够高效地计算出玩家当前需要持有的区块集合。这让租约签发逻辑从复杂的坐标计算中解脱出来，变得清晰明了。

### **2\. 推翻 1.2E10 的 TTL 设想**

在 1.2E10 的设想中，我们曾计划让 区块 (Block/Chunk) 自己持有 TTL (Time To Live)。  
但在 1.2F20 的实战研发中，我们推翻了这个方案。  
现在的设计是：TTL 由租约 (Lease) 持有。

* **旧方案**：区块自己倒计时，数到 0 就卸载。这导致当多个玩家同时在看一个区块时，倒计时逻辑变得极其复杂且容易出错。  
* **新方案**：区块本身不再关心时间。是“租约”在倒计时。只要还有一份有效的租约指向这个区块，它就是安全的。

目前，租约系统已完成 **80%** 的研发。通过 ConcurrentHashMap 的原子操作和精细的锁机制，我们已经攻克了并发修改租约集合的难题。预计很快它就能作为一个成熟的 Flex 组件，与 FlexChunk 正式联动。

## **四、物理服务的精度革命：PrecisionPos**

在升级 ServerWorldPhysicsService 的过程中，我们撞上了一个隐蔽但致命的问题：精度丢失。  
旧系统通过在 Service 中传递多个独立的 double 变量（x, y, z）来进行运算。这种方式不仅代码臃肿，不方便传递，而且在进行复杂的向量运算或跨区块边界检测时，极易出现细微的浮点误差。  
为了解决这个问题，我们研发了 PrecisionPos 类。  
它封装了高精度的坐标运算逻辑，确保在服务端进行物理模拟时，实体的位置计算能够精确无误。这为未来实现更复杂的碰撞检测和实体交互打下了坚实的数学基础。

## **下一步：告别 Simple，拥抱 Flex**

随着 FlexChunkLeaseService（租约服务）、ServerWorldEventBus（事件服务）以及高精度物理基础设施的就绪，旧时代的遗产——**SimpleServerChunk** 和 **SimpleChunkManager** 的历史使命已经结束。  
在接下来的版本中，我们将全速推进 **Flex 系列组件的实装**。并移除旧式的 Simple 组件，让基于调色板压缩、支持超高并发读写的新一代区块系统正式接管 OurCraft 的世界。  
感谢大家的支持。