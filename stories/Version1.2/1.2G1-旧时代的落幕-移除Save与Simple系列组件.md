# 1.2G - 旧时代的落幕

**日期**: 2025-12-07
**前置版本**: 1.2F24

## 概述

随着 1.2F24 里程碑中 **Flex区块系统** 与 **Action模型** 的全面实装，MyCraft 的服务端架构已经完成了从单体简单逻辑向 SOA（面向服务架构）与高并发模型的蜕变。

为了保证代码库的整洁与架构的统一，我们决定在 1.2G 版本中移除所有作为“脚手架”存在的旧时代核心模块。这些模块曾支撑了 MyCraft 从 1.0 到 1.2 早期版本的运行，但现在是时候向它们告别了。

## 移除清单

本次清理涉及以下包及其子模块：

1.  **Save 子系统 (SCA 1.0)** (`com.ksptool.ourcraft.server.world.save`)
    *   `SaveManager` (负责 JSON 索引与文件调度)
    *   `RegionFile`, `SimpleRegionManager` (负责 .sca/.sce 文件读写)
    *   `EntitySerializer` (旧版二进制 KV 序列化)
    *   `WorldIndex`, `PlayerIndex` (旧版 JSON 模型)
2.  **Simple Chunk 子系统** (`com.ksptool.ourcraft.server.world.chunk`)
    *   `SimpleChunkManager`
    *   `SimpleServerChunk`
    *   `SimpleChunkSerializer`
    *   `SimpleWorldGeneratorThread`
    *   *(注: SimpleEntity 系列暂予保留)*

## 致敬经典：它们曾如何工作

在 MyCraft 的 1.0 版本中，我们确立了 **SCA (Super Chunk Archive)** 的基本形态，这套系统在当时极具前瞻性。

### 1. Save 体系：第一代 SCA/SCE 架构

旧的 `SaveManager` 和 `RegionFile` 并非对 Minecraft Anvil 的简单模仿，而是我们自主研发的 **第一代二进制存储方案**。

*   **工作原理**：
    *   **40x40 Region 网格**：不同于常见的 32x32，旧系统采用了 40x40 (1600个区块) 的 Region 划分。
    *   **双文件策略 (.sca + .sce)**：
        *   **`.sca` (Super Chunk Archive)**：存储静态的地形数据（方块 ID、光照），采用 RLE 压缩。
        *   **`.sce` (Super Chunk Entity)**：存储动态的实体数据。这是一个大胆的尝试，试图用文件系统管理高频变动的实体。
    *   **自定义二进制 KV**：为了性能，我们没有使用 NBT，而是设计了一套**扁平化的二进制 KV 格式**（如 `core:pos.x`），配合 `EntitySerializer` 实现了高效的序列化。
    *   **JSON 索引**：使用 `world.index` 和 `players/[uuid].index` 来管理元数据，这是最早的“命名空间”尝试。
    *   **被动式保存**：依赖 `chunk.isDirty()` 和 `entity.isDirty()` 标记，仅在世界关闭或特定触发时将脏数据写回文件。
*   **历史价值**：
    *   它验证了“大文件聚合存储”的可行性，为后来的 Archive 系统积累了宝贵的经验。
    *   自定义 KV 格式的设计思想被证明是正确的，并被新系统部分继承。
*   **退出原因**：
    *   **实体存储的瓶颈**：事实证明，用文件 (`.sce`) 存储高频变动的实体（位置、血量）会导致严重的 IO 性能问题和碎片化，且难以支持复杂的查询。
    *   **缺乏事务性**：直接操作文件难以保证在服务器崩溃时的数据一致性。

### 2. Simple Chunk 体系：同步世界的容器

`SimpleChunkManager` 是与第一代 Save 系统配套的内存管理器。

*   **工作原理**：
    *   它维护一个简单的 `Map<Long, Chunk>`。
    *   加载逻辑是同步且硬编码的：`getChunk` -> 检查内存 -> 检查文件 -> 生成。
    *   它通过 `SimpleWorldGeneratorThread` 处理生成，但生命周期管理（加载/卸载）非常原始，容易在玩家跨越边界时造成“加载抖动 (Thrashing)”。

## 拥抱未来：新模块的变革

旧模块的离去是为了给更强大的系统腾出空间。接替它们的是经过深思熟虑的 **1.2 核心架构**。

### 1. Archive System：工业级混合存储架构 (SCA 2.0 + H2 DB)

接替 `SaveManager` 的是位于 `com.ksptool.ourcraft.server.archive` 的 **Archive Service**。这是一套采用了“动静分离”策略的工业级存储方案。

*   **动态数据：关系型数据库 (H2 Database)**
    *   我们将所有高频变动、需要事务支持的数据迁入了嵌入式数据库 **H2 (Server Mode)**，使用 HikariCP 连接池管理。
    *   **统一索引**：`ARCHIVE_INDEX_DB` 管理着所有核心表：
        *   `WORLD_INDEX`: 统一管理所有世界的元数据（Seed, Tick, SpawnPos）。
        *   `PLAYER_INDEX`: 玩家数据（位置、血量、经验）直接存表，支持 SQL 查询与统计。
        *   `GLOBAL_PALETTE`: 使用 `MERGE` 语法高效同步全局调色板，配合 Kryo 序列化属性，杜绝了 ID 错乱。
        *   `CHUNK_ENTITY`: 实体数据不再存入 `.sce` 文件，而是以二进制 Blob 形式存入数据库表，配合唯一索引 `(WORLD, X, Z)` 实现高效读写。
*   **静态地形：SCA 2.0 文件系统 (Super Chunk Archive)**
    *   对于体积大且相对静态的地形数据（方块 ID），我们保留并强化了 `.sca` 文件存储。
    *   **崩溃一致性 (Crash-Consistent)**：`SuperChunkArchiveFile` 采用了 **Append-Only (追加写)** 策略。
        *   新数据永远写入文件末尾，强制落盘 (fsync) 后才原子更新索引指针。即使在写入中途断电，旧数据也依然完好，彻底解决了“坏档”问题。
    *   **智能缓存**：引入 Caffeine 缓存库，使用 LRU 算法管理打开的文件句柄 (`RandomAccessFile`)，有效防止了操作系统文件句柄耗尽，同时减少了打开/关闭文件的系统调用开销。
    *   **碎片整理**：提供 `compact()` 机制，定期清理因追加写产生的“空洞”，保持文件紧凑。

### 2. Flex Chunk System：智能的租约管理

接替 `SimpleChunkManager` 的是 **FlexServerChunkService**。

*   **核心优势**：
    *   **租约系统 (Lease)**：引入了 TTL (Time To Live) 和引用计数机制。只有持有有效租约的区块才会驻留内存。这完美解决了旧系统的 Thrashing 问题。
    *   **分级 Tick**：Flex 区块支持不同等级的活跃度，允许我们只对玩家附近的区块进行高精度模拟，而远处的区块仅做基础维护。
    *   **并发安全**：专为多线程环境设计，配合 Action 模型，实现了真正的并行计算。

清理工作即刻开始。我们将移除 `server.world.save` 和 `server.world.chunk` (Simple系列) 下的所有代码。

