# 1.2E_9-引擎-统一线程池管理

## 背景
随着引擎架构的演进，我们发现线程池的管理变得愈发混乱。
- `ServerWorldManager` 自行维护了一个 `CachedThreadPool` 用于驱动世界逻辑 (`SWEU`)。
- `FlexServerChunkManager` 使用了一个静态的 `FixedThreadPool` 用于区块生成。
- 网络模块即将引入新的线程模型。

这种分散的管理方式带来了几个问题：
1. **生命周期管理困难**：服务器关闭时，需要分别调用各个组件的 shutdown 方法，容易遗漏导致进程无法彻底退出。
2. **资源竞争不可控**：各个模块独立创建线程池，缺乏全局视角的资源限制（例如总线程数限制）。
3. **配置不统一**：线程池参数硬编码在各个类中，无法统一通过配置文件调整。

## 重构目标
将所有核心线程池的生命周期（创建、配置、销毁）收敛到 `OurCraftServer` 类中，各子系统（WorldManager, ChunkManager）不再持有线程池的所有权，而是向 `OurCraftServer` 申请使用。

## 技术实现

### 1. `OurCraftServer` 统一托管
在 `OurCraftServer` 中定义了三大核心线程池：
- **SWEU_THREAD_POOL** (Server World Execution Unit Thread Pool):
    - 用于运行所有世界的逻辑更新循环。
    - 这是一个资源受限的池，确保世界逻辑线程数可控。
- **CHUNK_PROCESS_THREAD_POOL**:
    - 用于区块的加载、生成、I/O操作。
    - 替代了原先 `FlexServerChunkManager` 中的静态线程池。
- **NETWORK_THREAD_POOL**:
    - 基于 JDK 21 虚拟线程 (`Executors.newThreadPerTaskExecutor`)。
    - 处理高并发的网络连接和数据包收发。

### 2. 移除旧的实现
- 删除了 `ServerWorldManager` 中的 `executorService`。
- 删除了 `FlexServerChunkManager` 中的 `generationThreadPool` 静态字段及其初始化代码。
- 各个 Manager 现在通过 `OurCraftServer` 实例获取相应的线程池引用来提交任务。

### 3. 生命周期钩子
`OurCraftServer` 的 `initThreadPools()` 和 `shutdown()` 方法现在负责所有线程资源的申请与释放。`shutdown()` 能够确保按照正确的顺序优雅关闭所有服务，不再有僵尸线程残留。

## 意义
这次重构是引擎走向成熟的重要一步。它不仅解决了"JVM退出困难"的顽疾，也为后续的性能调优（如根据机器核心数动态调整线程池大小）奠定了基础。通过统一的入口，我们可以监控全服务器的线程状态，为将来的性能分析提供便利。

