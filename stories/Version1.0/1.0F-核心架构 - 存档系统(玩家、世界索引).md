# 项目经理推进需求

我们需要设计一个存档系统, 为了兼容多世界与多人游戏，我们的存档系统需要一个顶层的“命名空间”。最简单、最健壮的方法就是使用文件夹 其结构是

1./saves/[存档名称]/world.index(JSON它会列出在这份存档中所有可用的世界以及它们的name、seed、worldTime等其他字段)
2./saves/[存档名称]/players/[UUID].index (JSON 玩家数据)
3./saves/[存档名称]/[世界名]_chunk/a.0.0.sca (存储40X40个区块 有一个固定大小的索引头用来索引区块)
4./saves/[存档名称]/[世界名]_entity/e.0.0.sce

这个工程量非常大，我们似乎无法一次完成它 你需要查看现有代码 制定改造方案 我们可以先1、2开始 3、4下次再执行

# 技术经理制定研发计划

# 存档系统改造计划

本计划旨在重构现有的存档系统，以支持多世界和多人游戏。我们将引入一个顶层的“存档命名空间”，并使用 JSON 文件来管理世界和玩家数据。

## 阶段一：重构存档结构和世界管理

此阶段的目标是建立新的文件夹结构 `saves/[存档名称]/`，并用 `world.index` (JSON) 文件来管理世界列表。

1.  **引入 JSON 库**

    -   我将向项目（可能是 `pom.xml` 或 `build.gradle`）中添加 Google GSON 库，用于处理 JSON 文件的序列化和反序列化。

2.  **创建数据模型**

    -   创建 `WorldMetadata.java` 类，用于存储单个世界的信息，如 `name`, `seed`, `worldTime`。
    -   创建 `WorldIndex.java` 类，它包含一个 `List<WorldMetadata>`，对应 `world.index` 文件的结构。

3.  **创建新的存档管理器**

    -   创建一个新的 `SaveManager.java` 类。它将负责：
        -   列出 `saves` 目录下的所有存档（即所有子文件夹）。
        -   创建新的存档文件夹。
        -   加载和保存指定存档的 `world.index` 文件。

4.  **修改 `WorldManager.java`**

    -   改造此类，使其操作依赖于存档名称。
    -   `loadWorld` 和 `saveWorld` 等方法的签名将更改为 `loadWorld(String saveName, String worldName)`。
    -   内部路径构建逻辑将更新为 `saves/[saveName]/[worldName]_chunk/` 等新格式。
    -   移除旧的 `level.dat` 读写逻辑。

5.  **更新UI界面**

    -   **`SingleplayerMenu.java`**: 菜单将首先显示存档列表。选择存档后，再从该存档的 `world.index` 中读取并显示世界列表。
    -   **`CreateWorldMenu.java`**: 界面将增加一个选项，允许用户选择一个现有存档或创建一个新存档来存放新世界。

## 阶段二：实现玩家数据读写

此阶段我们将实现玩家数据的保存和加载。

1.  **创建玩家数据模型**

    -   创建 `PlayerIndex.java` 类，用于存储玩家数据，如位置、朝向、物品栏、生命值等。

2.  **扩展 `Player.java`**

    -   为 `Player` 类添加方法，用于将其状态捕获到一个 `PlayerIndex` 对象中，以及从 `PlayerIndex` 对象恢复其状态。

3.  **扩展 `SaveManager.java`**

    -   添加方法来处理玩家数据：
        -   `savePlayer(String saveName, UUID playerUUID, Player player)`: 将玩家数据保存到 `saves/[saveName]/players/[UUID].index`。
        -   `loadPlayer(String saveName, UUID playerUUID)`: 从对应的 JSON 文件加载玩家数据。

4.  **集成到 `Game.java`**

    -   在 `Game.java` 的 `loadWorld` 方法中，加载完世界后，调用 `saveManager.loadPlayer(...)` 来恢复玩家状态。
    -   在游戏退出或切换世界时（`cleanupWorld` 方法中），调用 `saveManager.savePlayer(...)` 来保存玩家的进度。

这个方案将逐步替换现有的简单存档机制，为您后续扩展区块和实体存储（第3、4步）打下坚实的基础。

# 研发工程师汇报

查看项目结构和构建配置：


[7 tools called]


查看 pom.xml 和 World 类的完整内容：


[4 tools called]


开始实施计划。先添加 GSON 依赖，然后创建数据模型和 SaveManager。


[5 tools called]


创建数据模型和 SaveManager：


[4 tools called]


创建 PlayerIndex 类：


[2 tools called]


检查 Player 类是否有 getHealth 方法，然后重构 WorldManager：


[3 tools called]


重构 WorldManager 以使用新的存档结构：


[2 tools called]


检查 World 类是否有 setGameTime 方法：


[2 tools called]


在 World 类中添加 setGameTime 方法：


[3 tools called]


查看 Game.java 中菜单状态的处理逻辑：


[1 tool called]


更新 SingleplayerMenu 和 CreateWorldMenu：


[4 tools called]


更新 CreateWorldMenu，添加存档选择功能：


[4 tools called]


更新 Game.java，集成新的存档系统和玩家数据保存/加载：


[2 tools called]


在 Player 类中添加保存和加载方法，并更新 Game.java：


[1 tool called]


在 Player 类中添加加载方法，并更新 Game.java：


[7 tools called]


修复导入错误：


[2 tools called]


导入已存在，可能是 IDE 缓存问题。检查代码逻辑是否正确：


[1 tool called]


修复 cleanupWorld 方法中的逻辑问题：


[1 tool called]


存档系统改造已完成。总结如下：

## 已完成的工作

1. **引入 GSON 库** - 在 `pom.xml` 中添加了 GSON 依赖

2. **创建数据模型**：
    - `WorldMetadata.java` - 存储单个世界的元数据
    - `WorldIndex.java` - 存储世界列表的索引文件结构
    - `PlayerIndex.java` - 存储玩家数据

3. **创建 SaveManager** - 管理存档文件夹结构和世界/玩家数据的保存与加载

4. **重构 WorldManager** - 更新为使用新的存档结构，方法签名改为 `loadWorld(String saveName, String worldName)`

5. **更新 UI 界面**：
    - `SingleplayerMenu` - 先显示存档列表，选择存档后再显示世界列表
    - `CreateWorldMenu` - 增加存档选择功能，可创建新存档或选择现有存档

6. **实现玩家数据保存/加载**：
    - 在 `Player` 类中添加了 `loadFromPlayerIndex` 方法
    - `SaveManager` 中实现了玩家数据的保存和加载

7. **集成到 Game.java**：
    - 更新了世界创建和加载逻辑以使用新的存档系统
    - 在 `cleanupWorld` 中自动保存玩家数据
    - 在 `loadWorld` 中自动加载玩家数据

存档系统已支持多世界和多人游戏结构，符合要求的文件夹结构。后续可在此基础上实现区块和实体的存储（第3、4步）。