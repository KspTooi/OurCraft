é¡¹ç›®ï¼š "MyCraft" æ€§èƒ½é‡æ„ - å¼‚æ­¥åŒºå—ç½‘æ ¼ç”Ÿæˆ

é—®é¢˜ï¼ˆå·²ç”± JProfiler ç¡®è®¤ï¼‰ï¼š Chunk.generateMesh æ–¹æ³•å ç”¨äº† 88.2% çš„ CPU æ—¶é—´ï¼Œå¹¶ä¸”å®ƒåœ¨ä¸»æ¸¸æˆå¾ªç¯ï¼ˆGame.update -> World.updateï¼‰ä¸­è¢«åŒæ­¥è°ƒç”¨ã€‚è¿™å¯¼è‡´äº†ä¸»çº¿ç¨‹è¢«ä¸¥é‡é˜»å¡ï¼Œå¼•å‘äº†å·¨å¤§çš„æ€§èƒ½å¡é¡¿ã€‚

ç›®æ ‡ï¼š å°† Chunk.generateMesh çš„è°ƒç”¨ä»ä¸»çº¿ç¨‹ (Main Thread) ç§»é™¤ï¼Œå°†å…¶åˆ†é…åˆ°ä¸€ä¸ªå•ç‹¬çš„åå°å·¥ä½œçº¿ç¨‹æ±  (Worker Thread Pool) ä¸­å¼‚æ­¥æ‰§è¡Œã€‚

æ‰§è¡Œè®¡åˆ’

ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºçº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—

    ChunkMeshGenerator (æ–°ç±»)ï¼š

        åˆ›å»ºä¸€ä¸ªæ–°ç±»ï¼Œä¾‹å¦‚ world.ChunkMeshGeneratorã€‚

        ExecutorService (çº¿ç¨‹æ± )ï¼š åœ¨è¿™ä¸ªç±»ä¸­ï¼Œåˆå§‹åŒ–ä¸€ä¸ª ExecutorService (çº¿ç¨‹æ± )ï¼Œä¾‹å¦‚ä½¿ç”¨ Executors.newFixedThreadPool(N)ï¼ŒN å¯ä»¥æ˜¯ Runtime.getRuntime().availableProcessors() - 1ã€‚

        Future å’Œ Mapï¼š éœ€è¦ä¸€ä¸ªæ–¹æ³• submitMeshTask(Chunk chunk)ï¼Œå®ƒå°†â€œç”Ÿæˆä»»åŠ¡â€æäº¤åˆ°çº¿ç¨‹æ± ï¼Œå¹¶è¿”å›ä¸€ä¸ª Future<MeshGenerationResult>ã€‚

    MeshGenerationResult (æ–°ç±»)ï¼š

        Chunk.generateMesh çš„â€œäº§å“â€ä¸å†æ˜¯ç›´æ¥çš„ Mesh å¯¹è±¡ï¼ˆå› ä¸ºOpenGLä¸Šä¸‹æ–‡åœ¨åå°çº¿ç¨‹ä¸­å¾ˆéº»çƒ¦ï¼‰ã€‚

        å®ƒçš„â€œäº§å“â€åº”è¯¥æ˜¯ä¸€ä¸ªçº¯æ•°æ®å¯¹è±¡ (POJO)ï¼ŒåŒ…å« generateMesh è®¡ç®—å‡ºçš„ float[] vertices, float[] texCoords, int[] indices ç­‰æ•°ç»„ã€‚

        class MeshGenerationResult { float[] vertices; ... }

ç¬¬äºŒé˜¶æ®µï¼šä¿®æ”¹ Chunk å’Œ World

    Chunk.javaï¼š

        generateMesh() æ–¹æ³•ç°åœ¨ä¸åº”è¯¥è¢« World ç›´æ¥è°ƒç”¨ã€‚

        Chunk éœ€è¦ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œä¾‹å¦‚ ChunkState { NEW, AWAITING_MESH, READY_TO_UPLOAD, READY }ã€‚

        Chunk è¿˜éœ€è¦ä¸€ä¸ª public void uploadToGPU(MeshGenerationResult result) æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šè¢«è°ƒç”¨ï¼Œå› ä¸ºå®ƒä¼šè°ƒç”¨ OpenGL æ–¹æ³•ï¼ˆnew Mesh(...), glBufferDataï¼‰ã€‚

    World.update() (é‡æ„)ï¼š

        World.update() å†ä¹Ÿ-ä¸-å…è®¸è°ƒç”¨ generateMesh()ã€‚

        å®ƒçš„æ–°èŒè´£æ˜¯ï¼š

            éå†ç©å®¶å‘¨å›´çš„ Chunkã€‚

            å¦‚æœå‘ç°ä¸€ä¸ª Chunk çŠ¶æ€æ˜¯ NEWï¼ˆéœ€è¦ç½‘æ ¼ï¼‰ï¼š

                è°ƒç”¨ chunkMeshGenerator.submitMeshTask(chunk)ã€‚

                å°† Chunk çŠ¶æ€è®¾ç½®ä¸º AWAITING_MESHã€‚

ç¬¬ä¸‰é˜¶æ®µï¼šåœ¨ä¸»çº¿ç¨‹ä¸Šâ€œå›æ”¶â€ç»“æœ

    Game.update() æˆ– Game.loop() (åœ¨ä¸»çº¿ç¨‹ä¸Š)ï¼š

        åœ¨ world.update() ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªæ–°æ­¥éª¤ï¼š

        æ£€æŸ¥å·²å®Œæˆçš„ä»»åŠ¡ï¼š å¾ªç¯æ£€æŸ¥ ChunkMeshGenerator ä¸­æ‰€æœ‰å·²å®Œæˆçš„ Futureã€‚

        è·å–ç»“æœï¼š MeshGenerationResult result = future.get();

        ä¸Šä¼ åˆ°GPUï¼š

            Chunk chunk = result.getChunk();

            chunk.uploadToGPU(result); (è¿™æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šå®‰å…¨åœ°åˆ›å»º Mesh å¯¹è±¡)

            chunk.setState(READY);


å¥½çš„ï¼Œè¿™ä¸ªé‡æ„è®¡åˆ’éå¸¸æ¸…æ™°ã€‚ä¸ºäº†ç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿç²¾ç¡®åœ°å®æ–½è¿™ä¸ªè®¡åˆ’ï¼Œæˆ‘é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹å½“å‰ä»£ç çš„ç»“æ„ã€‚æˆ‘ä¼šæŸ¥çœ‹ world åŒ…ä¸‹çš„æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ Chunk.java å’Œ World.javaï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£ç°æœ‰çš„ç½‘æ ¼ç”Ÿæˆé€»è¾‘ã€‚
å¥½çš„ï¼Œæˆ‘å·²è·å–æ–‡ä»¶åˆ—è¡¨ï¼ŒChunk.java å’Œ World.java å‡å­˜åœ¨ã€‚ç°åœ¨æˆ‘å°†é˜…è¯»ä»¥ä¸‹å…³é”®æ–‡ä»¶å†…å®¹ä»¥ç†è§£å½“å‰å®ç°ï¼š
src/main/java/com/ksptool/mycraft/core/Game.java (æŸ¥æ‰¾æ¸¸æˆå¾ªç¯)
src/main/java/com/ksptool/mycraft/world/World.java (æŸ¥çœ‹ update åŠ generateMesh çš„è°ƒç”¨æ–¹å¼)
src/main/java/com/ksptool/mycraft/world/Chunk.java (äº†è§£ generateMesh åŠå…¶å½“å‰çŠ¶æ€)


ğŸš€ æ€§èƒ½ä¼˜åŒ–è®¡åˆ’ï¼šåŒºå—ç½‘æ ¼ï¼ˆChunk Meshï¼‰å¼‚æ­¥ç”Ÿæˆ

ç›®æ ‡ï¼š å°†åŒºå—ç½‘æ ¼ç”Ÿæˆ (Chunk.generateMesh) çš„è®¡ç®—å¯†é›†å‹éƒ¨åˆ†ç§»å‡ºä¸»çº¿ç¨‹ï¼Œä»¥è§£å†³æ€§èƒ½ç“¶é¢ˆã€‚

ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºå¼‚æ­¥ä»»åŠ¡æ‰€éœ€çš„æ–°ç±»

1. MeshGenerationResult.java (æ–°æ–‡ä»¶)

åˆ›å»ºä¸€ä¸ª POJO (Plain Old Java Object) ç±»ï¼Œç”¨äºåœ¨çº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°ä¼ é€’ç½‘æ ¼æ•°æ®ï¼Œé¿å…åœ¨åå°çº¿ç¨‹ä¸­å¤„ç†ä»»ä½• OpenGL å¯¹è±¡ã€‚
Java

package com.ksptool.ourcraft.world;

public class MeshGenerationResult {
public final float[] vertices;
public final float[] texCoords;
public final float[] tints;
public final int[] indices;
public final Chunk chunk;

    public MeshGenerationResult(Chunk chunk, float[] vertices, float[] texCoords, float[] tints, int[] indices) {
        this.chunk = chunk;
        this.vertices = vertices;
        this.texCoords = texCoords;
        this.tints = tints;
        this.indices = indices;
    }
}

2. ChunkMeshGenerator.java (æ–°æ–‡ä»¶)

åˆ›å»ºè¯¥æ–°ç±»æ¥ç®¡ç†å¼‚æ­¥ç½‘æ ¼ç”Ÿæˆä»»åŠ¡ã€‚å®ƒå°†åŒ…å«ä¸€ä¸ªçº¿ç¨‹æ± å’Œç”¨äºæäº¤ä»»åŠ¡çš„é€»è¾‘ã€‚
Java

package com.ksptool.ourcraft.world;

import java.util.List;
import java.util.concurrent.*;

public class ChunkMeshGenerator {
private final ExecutorService executor;
private final List<Future<MeshGenerationResult>> pendingFutures = new CopyOnWriteArrayList<>();
private final World world;

    public ChunkMeshGenerator(World world) {
        this.world = world;
        int numThreads = Math.max(1, Runtime.getRuntime().availableProcessors() - 1);
        this.executor = Executors.newFixedThreadPool(numThreads);
    }

    public void submitMeshTask(Chunk chunk) {
        Callable<MeshGenerationResult> task = () -> chunk.calculateMeshData(world);
        Future<MeshGenerationResult> future = executor.submit(task);
        pendingFutures.add(future);
    }

    public List<Future<MeshGenerationResult>> getPendingFutures() {
        return pendingFutures;
    }

    public void shutdown() {
        executor.shutdown();
    }
}

ç¬¬äºŒé˜¶æ®µï¼šé‡æ„ Chunk å’Œ World

1. Chunk.java (ä¿®æ”¹)

ä¸º Chunk æ·»åŠ ä¸€ä¸ªçŠ¶æ€æœºï¼Œå¹¶å°† generateMesh æ–¹æ³•æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ•°æ®è®¡ç®—å’Œ GPU ä¸Šä¼ ã€‚

ğŸ”¹ æ·»åŠ  ChunkState æšä¸¾:

Java

public enum ChunkState {
NEW,
DATA_LOADED,       // åŒºå—æ•°æ®å·²åŠ è½½
AWAITING_MESH,     // å·²æäº¤ç½‘æ ¼è®¡ç®—ä»»åŠ¡
READY_TO_UPLOAD,   // ç½‘æ ¼æ•°æ®è®¡ç®—å®Œæˆ
READY              // å·²ä¸Šä¼ è‡³ GPUï¼Œå¯æ¸²æŸ“
}

ğŸ”¹ æ–¹æ³•å˜æ›´:

    æ–°å¢æ–¹æ³• calculateMeshDataï¼š åŒ…å«å½“å‰ generateMesh çš„æ‰€æœ‰è®¡ç®—é€»è¾‘ï¼Œè¿”å›ä¸€ä¸ª MeshGenerationResult å¯¹è±¡ã€‚

    æ–°å¢æ–¹æ³• uploadToGPUï¼š æ¥æ”¶ MeshGenerationResult å¹¶åœ¨ä¸»çº¿ç¨‹ä¸Šåˆ›å»º OpenGL Mesh å¯¹è±¡ã€‚

    ç§»é™¤æ—§çš„ generateMesh æ–¹æ³•ã€‚

2. World.java (ä¿®æ”¹)

ä¿®æ”¹ World çš„æ›´æ–°é€»è¾‘ï¼Œå°†ä»»åŠ¡æäº¤ç»™æ–°çš„ ChunkMeshGeneratorã€‚

    ç§»é™¤ meshQueueï¼šä¸å†éœ€è¦è¿™ä¸ªé˜Ÿåˆ—ã€‚

    é›†æˆ ChunkMeshGeneratorï¼š World å°†æŒæœ‰ä¸€ä¸ª ChunkMeshGenerator çš„å®ä¾‹ã€‚

    ä¿®æ”¹ World.update() é€»è¾‘ï¼š

        ç§»é™¤ä» meshQueue å–å‡ºä»»åŠ¡å¹¶è°ƒç”¨ generateMesh çš„å¾ªç¯ã€‚

        å½“ WorldGenerator ç”Ÿæˆå®ŒåŒºå—æ•°æ®å (Chunk çŠ¶æ€ä¸º DATA_LOADED)ï¼Œè°ƒç”¨ chunkMeshGenerator.submitMeshTask(chunk)ï¼Œå¹¶å°†åŒºå—çŠ¶æ€æ›´æ–°ä¸º AWAITING_MESHã€‚

ç¬¬ä¸‰é˜¶æ®µï¼šåœ¨ä¸»çº¿ç¨‹å›æ”¶ç»“æœ

Game.java (ä¿®æ”¹)

åœ¨ä¸»æ¸¸æˆå¾ªç¯ä¸­æ·»åŠ ä¸€ä¸ªæ–°æ­¥éª¤ï¼Œç”¨äºæ£€æŸ¥å·²å®Œæˆçš„ç½‘æ ¼ç”Ÿæˆä»»åŠ¡å¹¶å°†ç»“æœä¸Šä¼ åˆ° GPUã€‚

ğŸ”¹ åœ¨ Game.update() ä¸­æ·»åŠ æ–°é€»è¾‘:

    åœ¨ world.update() è°ƒç”¨ä¹‹åï¼Œéå† chunkMeshGenerator ä¸­çš„ pendingFutures åˆ—è¡¨ã€‚

    å¯¹äºæ¯ä¸ªå·²å®Œæˆçš„ Future (future.isDone()):

        è°ƒç”¨ future.get() è·å– MeshGenerationResultã€‚

        ä»ç»“æœä¸­è·å– Chunk å¯¹è±¡ã€‚

        è°ƒç”¨ chunk.uploadToGPU(result)ã€‚

        å°† Chunk çŠ¶æ€è®¾ç½®ä¸º READYã€‚

        ä» pendingFutures åˆ—è¡¨ä¸­ç§»é™¤è¯¥ futureã€‚

è¿™ä¸ªè®¡åˆ’ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘å®Œæ•´ï¼Œå°†ç¡®ä¿ç½‘æ ¼ç”Ÿæˆè¿‡ç¨‹å®ç°é«˜æ•ˆçš„å¼‚æ­¥å¤„ç†ã€‚

æ¥ä¸‹æ¥ï¼Œæ‚¨å¸Œæœ›æˆ‘ä¸ºæ‚¨æ•´ç†ç¬¬ä¸€é˜¶æ®µä¸­ MeshGenerationResult.java å’Œ ChunkMeshGenerator.java ç±»çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œè¿˜æ˜¯å¼€å§‹è§„åˆ’ç¬¬äºŒé˜¶æ®µçš„ä»£ç é‡æ„ï¼Ÿ


æŸ¥çœ‹ `WorldGenerator` çš„å®ç°ï¼Œäº†è§£ç°æœ‰åŒºå—ç”Ÿæˆæµç¨‹ï¼š


[2 tools called]


å¼€å§‹å®æ–½è®¡åˆ’ã€‚å…ˆåˆ›å»º `MeshGenerationResult` ç±»ï¼š


[4 tools called]


æŸ¥çœ‹ `Mesh` ç±»ï¼Œäº†è§£å¦‚ä½•åˆ›å»º Mesh å¯¹è±¡ï¼š


[1 tool called]


é‡æ„ `Chunk` ç±»ï¼š


[2 tools called]


é‡æ„ `Chunk` ç±»ï¼šæ·»åŠ çŠ¶æ€æšä¸¾å’Œå­—æ®µï¼Œæ‹†åˆ† `generateMesh` ä¸º `calculateMeshData` å’Œ `uploadToGPU`ï¼Œå¹¶ç§»é™¤æ—§çš„ `generateMesh`ã€‚


[4 tools called]


æ›´æ–° `World` ç±»ï¼š


[6 tools called]


ä¿®å¤ `WorldGenerator`ï¼Œå¹¶æ›´æ–° `World` ä¸­å‰©ä½™çš„ `generateMesh` è°ƒç”¨ï¼š


[3 tools called]


æ›´æ–° `World` ä¸­å‰©ä½™çš„ `generateMesh` è°ƒç”¨ï¼š


[4 tools called]


æ›´æ–° `World.update()`ï¼Œç¡®ä¿åŒºå—æ•°æ®ç”Ÿæˆå®Œæˆåæ·»åŠ åˆ° chunks mapï¼š


[1 tool called]


æ›´æ–° `World.update()`ï¼Œç¡®ä¿åŒºå—æ•°æ®ç”Ÿæˆå®Œæˆåæ·»åŠ åˆ° chunks mapï¼š


[1 tool called]


æ›´æ–° `Game` ç±»ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­æ£€æŸ¥å·²å®Œæˆçš„ç½‘æ ¼ç”Ÿæˆä»»åŠ¡å¹¶ä¸Šä¼ åˆ° GPUï¼š


[3 tools called]


æ£€æŸ¥ç¼–è¯‘é”™è¯¯ï¼š


[1 tool called]


ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥ï¼š


[2 tools called]


é‡æ–°è¯»å–æ–‡ä»¶ä»¥ç¡®è®¤ï¼š


[1 tool called]


æ–‡ä»¶å·²æ­£ç¡®æ›´æ–°ã€‚å®Œæˆæœ€åçš„ todoï¼š


[1 tool called]


é‡æ„å·²å®Œæˆã€‚ä¸»è¦æ›´æ”¹ï¼š

1. **åˆ›å»ºäº† `MeshGenerationResult.java`**ï¼šç”¨äºåœ¨çº¿ç¨‹é—´ä¼ é€’ç½‘æ ¼æ•°æ®çš„ POJO ç±»ã€‚

2. **åˆ›å»ºäº† `ChunkMeshGenerator.java`**ï¼šç®¡ç†çº¿ç¨‹æ± å’Œå¼‚æ­¥ç½‘æ ¼ç”Ÿæˆä»»åŠ¡ã€‚

3. **é‡æ„äº† `Chunk.java`**ï¼š
    - æ·»åŠ äº† `ChunkState` æšä¸¾ï¼ˆNEW, DATA_LOADED, AWAITING_MESH, READY_TO_UPLOAD, READYï¼‰
    - å°† `generateMesh` æ‹†åˆ†ä¸º `calculateMeshData`ï¼ˆè¿”å› `MeshGenerationResult`ï¼‰å’Œ `uploadToGPU`ï¼ˆåœ¨ä¸»çº¿ç¨‹åˆ›å»º OpenGL Meshï¼‰

4. **æ›´æ–°äº† `World.java`**ï¼š
    - ç§»é™¤äº† `meshQueue`
    - é›†æˆäº† `ChunkMeshGenerator`
    - ä¿®æ”¹äº† `update()` æ–¹æ³•ï¼Œå½“åŒºå—æ•°æ®ç”Ÿæˆå®Œæˆåæäº¤ç½‘æ ¼ç”Ÿæˆä»»åŠ¡
    - æ›´æ–°äº† `setBlockState` å’Œ `generateChunkSynchronously` æ–¹æ³•

5. **æ›´æ–°äº† `WorldGenerator.java`**ï¼šç§»é™¤äº†å¯¹ `meshQueue` çš„ä¾èµ–ï¼Œåœ¨æ•°æ®ç”Ÿæˆå®Œæˆåè®¾ç½®åŒºå—çŠ¶æ€ä¸º `DATA_LOADED`ã€‚

6. **æ›´æ–°äº† `Game.java`**ï¼šåœ¨ä¸»æ¸¸æˆå¾ªç¯ä¸­æ·»åŠ äº†æ£€æŸ¥å·²å®Œæˆç½‘æ ¼ä»»åŠ¡å¹¶ä¸Šä¼ åˆ° GPU çš„é€»è¾‘ã€‚

ç½‘æ ¼ç”Ÿæˆå·²ä»ä¸»çº¿ç¨‹ç§»è‡³åå°çº¿ç¨‹æ± ï¼Œåº”èƒ½æ˜¾è‘—å‡å°‘ä¸»çº¿ç¨‹é˜»å¡å¹¶æå‡æ€§èƒ½ã€‚