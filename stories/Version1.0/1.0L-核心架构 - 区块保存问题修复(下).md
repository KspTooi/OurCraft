# é¡¹ç›®ç»ç†æ¨è¿›éœ€æ±‚

ç»è¿‡è¿™æ¬¡ä¿®å¤ä»¥åï¼Œæˆ‘å‘ç°ç©å®¶çš„åæ ‡ã€ä¿¯ä»°è§’èƒ½å¤Ÿæ­£ç¡®ä¿å­˜ ä½†åŒºå—æ•°æ®ã€è¢«æŒ–æ˜çš„æ–¹å—ã€æ”¾ç½®çš„æ–¹å— ä¾ç„¶ä¼šåœ¨é€€å‡ºé‡æ–°è¿›å…¥åè¢«è¿˜åŸ è¯·æ’æŸ¥åˆ†ææ˜¯å“ªä¸ªéƒ¨åˆ†çš„é—®é¢˜ å¹¶åˆ¶å®šä¿®å¤TODOLIST
[1K-æ ¸å¿ƒæ¶æ„ - åŒºå—ä¿å­˜é—®é¢˜ä¿®å¤(ä¸­).md](1K-æ ¸å¿ƒæ¶æ„ - åŒºå—ä¿å­˜é—®é¢˜ä¿®å¤(ä¸­).md)

# æŠ€æœ¯ç»ç†åˆ¶å®šç ”å‘è®¡åˆ’

ğŸ’¾ åŒºå—æ•°æ®ä¸¢å¤±é—®é¢˜åˆ†æä¸è¯Šæ–­

â“ æ ¸å¿ƒé—®é¢˜å®šæ€§

ç©å®¶æ•°æ®å¯ä»¥æ­£ç¡®ä¿å­˜ï¼Œä½†åŒºå—æ•°æ®ï¼ˆæ–¹å—å˜æ›´ï¼‰ä¾ç„¶ä¸¢å¤±ã€‚è¿™è¡¨æ˜é—®é¢˜ä¸åœ¨äºåŒºå—æ•°æ®çš„åºåˆ—åŒ–æ ¼å¼ï¼Œè€Œåœ¨äºä¿®æ”¹è¿‡çš„åŒºå—æ²¡æœ‰è¢«æ­£ç¡®åœ°æ ‡è®°å¹¶å†™å…¥æ–‡ä»¶ã€‚æ¸¸æˆå¯èƒ½æ ¹æœ¬æ²¡æœ‰æ„è¯†åˆ°æŸä¸ªåŒºå—å·²ç»è¢«ä¿®æ”¹ã€‚

ğŸ” å®šä½é—®é¢˜è®¡åˆ’

    è¿½è¸ª ChunkSerializer.serialize çš„è°ƒç”¨é“¾ï¼š äº†è§£åŒºå—æ˜¯ä½•æ—¶ä»¥åŠå¦‚ä½•è¢«ä¿å­˜çš„ã€‚

    æ£€æŸ¥åŒºå—çš„â€œè„â€çŠ¶æ€ç®¡ç†ï¼š åœ¨ Chunk.java ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ dirty flagï¼ˆå·²ä¿®æ”¹/éœ€è¦ä¿å­˜æ ‡è®°ï¼‰ã€‚

    åˆ†æä¸–ç•Œä¿å­˜é€»è¾‘ï¼š å¼„æ¸…æ¸¸æˆé€€å‡ºæˆ–æ‰‹åŠ¨ä¿å­˜æ—¶ï¼Œå¦‚ä½•æ‰¾åˆ°æ‰€æœ‰è¢«æ ‡è®°ä¸ºâ€œå·²ä¿®æ”¹â€çš„åŒºå—å¹¶å°†å…¶å†™å…¥æ–‡ä»¶ã€‚

ğŸ’¡ è¯Šæ–­ç»“æœä¸å…³é”®å‘ç°

ç»è¿‡ä»£ç åˆ†æï¼Œæˆ‘å‘ç°äº†å‡ ä¸ªå…³é”®ç‚¹ï¼š

1. ä¿å­˜é€»è¾‘è§¦å‘æœºåˆ¶ç¼ºå¤±

   ChunkSerializer.serialize ä»æœªè¢«ä¸»åŠ¨è°ƒç”¨: æ²¡æœ‰ä»£ç ä¸»åŠ¨è°ƒç”¨åŒºå—çš„åºåˆ—åŒ–æ–¹æ³•ã€‚è¿™æ„å‘³ç€å³ä½¿åºåˆ—åŒ–é€»è¾‘æœ¬èº«å·²ä¿®å¤ï¼Œç¨‹åºä¹Ÿä»æœªå°è¯•æ‰§è¡Œå®ƒã€‚

   å®ä½“ä¿å­˜é€»è¾‘æ˜¯æ­£å¸¸çš„: EntitySerializer.serialize è¢«æ­£å¸¸è°ƒç”¨ï¼Œå¯ä½œä¸ºå‚è€ƒã€‚

   å­˜åœ¨åŒºå—å¸è½½æ—¶çš„ä¿å­˜é€»è¾‘: åœ¨ World.java çš„ update æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€æ®µé€»è¾‘ç”¨äºåœ¨åŒºå—è¿œç¦»ç©å®¶è€Œè¢«å¸è½½æ—¶ï¼Œæ£€æŸ¥å…¶ isDirty æ ‡å¿—å¹¶è¿›è¡Œä¿å­˜ã€‚

   World.java (Lines 163-178)

   Java

        if (chunk.isDirty() && regionManager != null && StringUtils.isNotBlank(saveName)) {
            // ... è®¡ç®—åŒºåŸŸåæ ‡ ...
            try {
                logger.debug("å¸è½½æ—¶ä¿å­˜è„åŒºå— [{},{}]", chunkX, chunkZ);
                byte[] compressedData = ChunkSerializer.serialize(chunk);
                // ... å†™å…¥æ–‡ä»¶é€»è¾‘ ...
                chunk.markDirty(false); // ä¿å­˜åæ¸…é™¤è„æ ‡è®°
            } catch (Exception e) {
                logger.error("å¸è½½æ—¶ä¿å­˜åŒºå—å¤±è´¥ [{},{}]", chunkX, chunkZ, e);
            }
        }

2. setBlockState æ–¹æ³•æœ‰ç¼ºé™· (æ ¹æœ¬åŸå› )

å½“ç©å®¶æ”¾ç½®æˆ–ç ´åæ–¹å—æ—¶ï¼Œä¼šè°ƒç”¨ World.setBlockStateï¼Œè¿›è€Œè°ƒç”¨ Chunk.setBlockStateã€‚

âœ… Chunk.java - è„æ ‡è®°è®¾ç½®æ­£ç¡®

Chunk.setBlockState ä¼šæ­£ç¡®åœ°è°ƒç”¨ markDirty(true)ï¼š

    Chunk.java (Lines 50-55)

    Java

        public void setBlockState(int x, int y, int z, int stateId) {
            if (x >= 0 && x < CHUNK_SIZE && y >= 0 && y < CHUNK_HEIGHT && z >= 0 && z < CHUNK_SIZE) {
                blockStates[x][y][z] = stateId;
                needsUpdate = true;
                markDirty(true); // <-- **è¿™é‡Œè®¾ç½®äº†è„æ ‡è®°**
            }
        }

âŒ World.java - è„æ ‡è®°è°ƒç”¨ç¼ºå¤±

ç„¶è€Œï¼Œåœ¨ World.setBlockState æ–¹æ³•ä¸­ï¼Œè™½ç„¶å®ƒæ‹¿åˆ°äº† Chunk å¯¹è±¡å¹¶è°ƒç”¨äº† chunk.setBlockStateï¼Œä½†å®ƒå¿˜è®°äº†åœ¨è‡ªå·±è¿™ä¸ªå±‚é¢ä¹Ÿè°ƒç”¨ chunk.markDirty(true)ã€‚

    World.java (Lines 435-448)

    Java

        public void setBlockState(int x, int y, int z, int stateId) {
            // ... è®¡ç®—åŒºå—å’Œæœ¬åœ°åæ ‡ ...
            Chunk chunk = chunks.get(key);
            // ... è·å–æˆ–åŠ è½½åŒºå—é€»è¾‘ ...
            int localX = x - chunkX * Chunk.CHUNK_SIZE;
            int localZ = z - chunkZ * Chunk.CHUNK_SIZE;
            chunk.setBlockState(localX, y, localZ, stateId); // <-- **è°ƒç”¨äº† chunk å†…éƒ¨çš„æ–¹æ³•**
            // **ç¼ºå°‘ chunk.markDirty(true);**
        }

ç”±äº World.setBlockState å†…éƒ¨çš„é€»è¾‘åªè°ƒç”¨äº† chunk.setBlockStateï¼Œè€Œæ²¡æœ‰åœ¨ World å±‚é¢è¿›è¡Œä»»ä½•é¢å¤–çš„ markDirty æ“ä½œï¼Œå¯¼è‡´åŒºå—å†…å®¹æ”¹å˜åï¼Œä»æœªè¢«æ ‡è®°ä¸ºâ€œè„â€ã€‚

ğŸ› ï¸ ç»“è®ºä¸è§£å†³æ–¹æ¡ˆ

é—®é¢˜çš„æ ¹æºåœ¨äºï¼š World.setBlockState æ–¹æ³•æ²¡æœ‰åœ¨ä¿®æ”¹æ–¹å—åå°†å¯¹åº”çš„åŒºå—æ ‡è®°ä¸ºâ€œè„çŠ¶æ€â€ï¼ˆdirtyï¼‰ã€‚è¿™ä½¿å¾—ä¿å­˜æœºåˆ¶ï¼ˆæ— è®ºæ˜¯åœ¨åŒºå—å¸è½½æ—¶è¿˜æ˜¯æ¸¸æˆé€€å‡ºæ—¶ï¼‰éƒ½è·³è¿‡äº†å¯¹è¿™äº›å·²ä¿®æ”¹åŒºå—çš„ä¿å­˜æ“ä½œã€‚

è§£å†³æ–¹æ¡ˆï¼š

éœ€è¦åœ¨ World.setBlockState æ–¹æ³•ä¸­ï¼Œåœ¨è°ƒç”¨å®Œ chunk.setBlockState åï¼Œæ‰‹åŠ¨æ·»åŠ ä¸€è¡Œä»£ç æ¥æ ‡è®°åŒºå—ä¸ºè„çŠ¶æ€ã€‚

# é¡¾é—®è¯„ä¼°

çœ‹å®Œäº†ä½ çš„æŠ€æœ¯ç»ç†çš„è¿™ä»½æŠ¥å‘Šï¼Œæˆ‘å¿…é¡»è¯´ï¼š

è¿™ä»½æŠ¥å‘Šæ˜¯ä¸€æ¬¡éå¸¸å‡ºè‰²çš„è°ƒè¯•ã€‚å®ƒå‡†ç¡®åœ°æŒ‡å‡ºäº†é—®é¢˜çš„ç—‡çŠ¶ï¼ˆç©å®¶ä¿å­˜ï¼ŒåŒºå—ä¸ä¿å­˜ï¼‰å’Œå…³é”®è¯æ®ï¼ˆChunkSerializer.serialize ä»æœªè¢«è°ƒç”¨ï¼‰ã€‚

ç„¶è€Œï¼Œåœ¨ä»”ç»†åˆ†æäº†ç»ç†è‡ªå·±æä¾›çš„ä»£ç è¯æ®åï¼Œæˆ‘è®¤ä¸ºä»–å¯¹**â€œæ ¹æœ¬åŸå› â€çš„è¯Šæ–­æ˜¯ä¸æ­£ç¡®**çš„â€”â€”å°½ç®¡ä»–å·²ç»æ‰¾åˆ°äº†è§£å†³é—®é¢˜æ‰€éœ€çš„æ‰€æœ‰çº¿ç´¢ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¾®å¦™çš„â€œç¯ä¸‹é»‘â€é—®é¢˜ã€‚

ä¸ºä»€ä¹ˆç»ç†çš„è¯Šæ–­æ˜¯é”™è¯¯çš„

ä½ çš„æŠ€æœ¯ç»ç†çš„ç»“è®ºæ˜¯ï¼šWorld.setBlockState æ–¹æ³•å¿˜è®°è°ƒç”¨ chunk.markDirty(true)ã€‚

è¿™æ˜¯é”™è¯¯çš„ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–è‡ªå·±æä¾›çš„ä»£ç è¯æ®ï¼š

    World.java (ç¬¬435-448è¡Œ) ç¡®å®è°ƒç”¨äº† chunk.setBlockState(...)ã€‚

    Chunk.java (ç¬¬50-55è¡Œ) åœ¨å…¶ setBlockState æ–¹æ³•å†…éƒ¨ ç¡®å®è°ƒç”¨äº† markDirty(true)ã€‚

é€»è¾‘é“¾æ˜¯å®Œæ•´çš„ï¼š World.setBlockState -> chunk.setBlockState -> chunk.markDirty(true)ã€‚

è¿™æ„å‘³ç€ï¼Œå½“ä½ æŒ–æ˜æ–¹å—æ—¶ï¼Œå¯¹åº”çš„åŒºå—å·²ç»è¢«æ­£ç¡®æ ‡è®°ä¸ºâ€œè„â€çŠ¶æ€äº†ã€‚

é‚£ä¹ˆï¼ŒçœŸæ­£çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ

çœŸæ­£çš„é—®é¢˜æ˜¯ä½ çš„æŠ€æœ¯ç»ç†å‘ç°çš„ç¬¬ä¸€ä¸ªè¯æ®ï¼š

    ChunkSerializer.serialize ä»æœªè¢«è°ƒç”¨ã€‚

è¿™æ„å‘³ç€ï¼Œå³ä½¿åŒºå—è¢«æ­£ç¡®æ ‡è®°ä¸º isDirty = trueï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•ä»£ç åœ¨æ¸¸æˆé€€å‡ºæ—¶å»æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œå¹¶æ‰§è¡Œä¿å­˜ã€‚

è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä»–å‘ç°çš„ç¬¬ä¸‰ä¸ªè¯æ®ï¼š

    å­˜åœ¨åŒºå—å¸è½½æ—¶çš„ä¿å­˜é€»è¾‘ï¼ˆåœ¨ World.java çš„ update æ–¹æ³•ä¸­ï¼‰ã€‚

è¿™å°±æ˜¯é—®é¢˜çš„æ ¹æºï¼š

    ä½ ä¿®æ”¹äº†ä½ è„šä¸‹çš„åŒºå— (chunkX, chunkZ)ã€‚å®ƒè¢«æ­£ç¡®æ ‡è®°ä¸º isDirty = trueã€‚

    ä½ é€€å‡ºæ¸¸æˆã€‚

    åœ¨é€€å‡ºæ—¶ï¼Œæ¸¸æˆè°ƒç”¨äº†â€œä¿å­˜ç©å®¶â€çš„é€»è¾‘ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆç©å®¶åæ ‡èƒ½ä¿å­˜ï¼‰ã€‚

    ä½†æ˜¯ï¼Œæ¸¸æˆæ²¡æœ‰è°ƒç”¨â€œä¿å­˜åŒºå—â€çš„é€»è¾‘ã€‚

    ä½ å¯èƒ½ä¼šé—®ï¼šé‚£ World.update é‡Œçš„å¸è½½ä¿å­˜é€»è¾‘å‘¢ï¼Ÿ

    ç­”æ¡ˆæ˜¯ï¼š å½“ä½ é€€å‡ºæ¸¸æˆæ—¶ï¼Œä½ è„šä¸‹çš„åŒºå— (chunkX, chunkZ) æ˜¯å·²åŠ è½½çŠ¶æ€ï¼Œå®ƒæ²¡æœ‰è¢«å¸è½½ã€‚å› æ­¤ï¼Œé‚£æ®µâ€œå¸è½½æ—¶ä¿å­˜â€çš„ä»£ç ä¹Ÿæ ¹æœ¬ä¸ä¼šè¿è¡Œã€‚

ç»“è®ºï¼š ä½ çš„æ¸¸æˆå®Œå…¨ç¼ºå¤±äº†â€œé€€å‡ºæ—¶ä¿å­˜è„åŒºå—â€çš„åŠŸèƒ½ã€‚å®ƒåªæœ‰â€œå¸è½½æ—¶ä¿å­˜â€å’Œâ€œé€€å‡ºæ—¶ä¿å­˜ç©å®¶â€çš„åŠŸèƒ½ã€‚

æ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆ

ä½ çš„æŠ€æœ¯ç»ç†çš„ä¿®å¤è®¡åˆ’ï¼ˆåœ¨ World.setBlockState ä¸­æ·»åŠ  markDirtyï¼‰æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºå®ƒé‡å¤äº† Chunk.java å·²ç»åšè¿‡çš„å·¥ä½œã€‚

çœŸæ­£çš„ä¿®å¤æ–¹æ¡ˆæ˜¯ï¼š

æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°åœ¨æ¸¸æˆé€€å‡ºæ—¶å·²ç»æˆåŠŸä¿å­˜äº†ç©å®¶æ•°æ®çš„é‚£æ®µä»£ç ï¼ˆå¾ˆå¯èƒ½åœ¨ WorldManager.saveWorld æˆ– Game.cleanupWorld ä¸­ï¼‰ï¼Œå¹¶åœ¨åŒä¸€ä¸ªåœ°æ–¹æ·»åŠ â€œä¿å­˜è„åŒºå—â€çš„é€»è¾‘ã€‚

è®¡åˆ’ï¼š

    å®šä½ï¼š æ‰¾åˆ° Game.cleanupWorld() æˆ– WorldManager.saveWorld() æ–¹æ³•ã€‚æˆ‘ä»¬ä»ä¸Šä¸€ä¸ªä¿®å¤è®¡åˆ’ä¸­çŸ¥é“ï¼Œè¿™é‡Œæ˜¯ä¿å­˜ç©å®¶çš„åœ°æ–¹ã€‚

    ä¿®æ”¹ï¼š åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œåœ¨ä¿å­˜ç©å®¶æ•°æ®çš„æ—è¾¹ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼š

        éå†æ‰€æœ‰å·²åŠ è½½çš„åŒºå—ï¼ˆä¾‹å¦‚ world.chunks.values()ï¼‰ã€‚

        æ£€æŸ¥æ¯ä¸€ä¸ª chunkï¼šif (chunk.isDirty()) { ... }

        å¦‚æœä¸º "true"ï¼Œåˆ™è°ƒç”¨ World.java ä¸­é‚£æ®µå·²ç»å†™å¥½çš„ä¿å­˜é€»è¾‘ï¼ˆåºåˆ—åŒ–ã€å†™å…¥ RegionFileï¼‰ã€‚

ä½ çš„æŠ€æœ¯ç»ç†æ˜¯ä¸€ä½å‡ºè‰²çš„â€œä¾¦æ¢â€ï¼ˆä»–æ‰¾åˆ°äº†æ‰€æœ‰çº¿ç´¢ï¼‰ï¼Œä½†ä»–æŒ‡æ§äº†é”™è¯¯çš„â€œå«Œç–‘äººâ€ã€‚çœŸæ­£çš„ç½ªé­ç¥¸é¦–æ˜¯â€œé€€å‡ºä¿å­˜â€åŠŸèƒ½ï¼Œå®ƒç©å¿½èŒå®ˆï¼Œåªä¿å­˜äº†ç©å®¶ï¼Œå´å¿˜è®°äº†ä¿å­˜ä¸–ç•Œã€‚

# æŠ€æœ¯ç»ç†ç¡®è®¤

ğŸ’¡ æ‚¨çš„é¡¾é—®æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼šæ–°çš„è¯Šæ–­ä¸ä¿®å¤è®¡åˆ’

æ‚¨å¥½ï¼Œåœ¨ä»”ç»†é˜…è¯»äº†æ‚¨é¡¾é—®çš„åˆ†æå¹¶é‡æ–°å®¡è§†äº†ä»£ç ä¹‹åï¼Œæˆ‘å¿…é¡»æ‰¿è®¤ï¼šæ‚¨çš„é¡¾é—®æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œæˆ‘ä¹‹å‰çš„è¯Šæ–­æ˜¯é”™è¯¯çš„ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¾®å¦™çš„é—®é¢˜ï¼Œé¡¾é—®çš„æ´å¯ŸåŠ›éå¸¸æ•éŠ³ã€‚æˆ‘ä¸ºæˆ‘ä¹‹å‰çš„é”™è¯¯åˆ†æè¡¨ç¤ºæ­‰æ„ã€‚

ğŸ§ ä¸ºä»€ä¹ˆé¡¾é—®æ˜¯æ­£ç¡®çš„

æˆ‘ä¹‹å‰çš„ç»“è®ºæ˜¯ World.setBlockState æ–¹æ³•å¿˜è®°äº†è°ƒç”¨ chunk.markDirty(true)ã€‚ä½†æ­£å¦‚æ‚¨çš„é¡¾é—®æ‰€æŒ‡å‡ºçš„ï¼Œè¿™ä¸ªè°ƒç”¨é“¾å®é™…ä¸Šæ˜¯å®Œæ•´çš„ï¼š

    World.java ä¸­çš„ setBlockState è°ƒç”¨äº† chunk.setBlockState(...)ã€‚

    Chunk.java ä¸­çš„ setBlockState åœ¨å…¶å†…éƒ¨è°ƒç”¨äº† markDirty(true)ã€‚

è¿™æ„å‘³ç€ï¼Œå½“æ‚¨ä¿®æ”¹ä¸€ä¸ªæ–¹å—æ—¶ï¼Œå®ƒæ‰€åœ¨çš„åŒºå—å·²ç»è¢«æ­£ç¡®åœ°æ ‡è®°ä¸ºéœ€è¦ä¿å­˜çš„çŠ¶æ€äº†ã€‚æˆ‘ä¹‹å‰æå‡ºçš„åœ¨ World.java ä¸­å¢åŠ  markDirty è°ƒç”¨çš„ä¿®å¤æ–¹æ¡ˆæ˜¯å¤šä½™ä¸”æ— æ•ˆçš„ã€‚

ğŸš¨ çœŸæ­£çš„æ ¹æœ¬åŸå›  (ç¯ä¸‹é»‘)

çœŸæ­£çš„é—®é¢˜ï¼Œæ­£å¦‚é¡¾é—®æ‰€è¯´ï¼Œæ˜¯æ¸¸æˆå®Œå…¨ç¼ºå¤±äº†â€œé€€å‡ºæ—¶ä¿å­˜æ‰€æœ‰å·²ä¿®æ”¹åŒºå—â€çš„æœºåˆ¶ã€‚

    ç°æœ‰ä¿å­˜é€»è¾‘çš„ç¼ºé™·ï¼š åœ¨ World.java ä¸­ï¼Œç¡®å®å­˜åœ¨ä¿å­˜è„åŒºå—çš„é€»è¾‘ï¼Œä½†å®ƒåªåœ¨åŒºå—è¢«å¸è½½ï¼ˆå³ç©å®¶ç§»åŠ¨åˆ°è¶³å¤Ÿè¿œçš„åœ°æ–¹ï¼‰æ—¶æ‰ä¼šè§¦å‘ã€‚

    ç¯ä¸‹é»‘ï¼š å½“æ‚¨é€€å‡ºæ¸¸æˆæ—¶ï¼Œæ‚¨è§’è‰²å‘¨å›´çš„åŒºå—ä»ç„¶æ˜¯åŠ è½½çŠ¶æ€ï¼Œå®ƒä»¬ä»æœªè¢«â€œå¸è½½â€ã€‚å› æ­¤ï¼Œè¿™æ®µâ€œå¸è½½æ—¶ä¿å­˜â€çš„ä»£ç æ ¹æœ¬æ²¡æœ‰æœºä¼šå¯¹è¿™äº›æœ€é‡è¦çš„åŒºå—è¿è¡Œã€‚

ç»“è®ºï¼š æ¸¸æˆåªä¿å­˜äº†ç©å®¶æ•°æ®å’Œé‚£äº›è¢«å¸è½½çš„è¿œæ–¹åŒºå—ï¼Œå´å¿˜è®°äº†ä¿å­˜åœ¨ç©å®¶é€€å‡ºæ—¶ä»å¤„äºæ´»åŠ¨çŠ¶æ€çš„åŒºå—ã€‚

âœ… æ­£ç¡®çš„ä¿®å¤è®¡åˆ’

åŸºäºé¡¾é—®çš„æ­£ç¡®åˆ†æï¼Œæˆ‘ä¸ºæ‚¨åˆ¶å®šäº†ä¸€ä»½æ–°çš„ã€æ›´ç²¾ç¡®çš„ä¿®å¤è®¡åˆ’ã€‚è¿™ä¸ªè®¡åˆ’çš„æ ¸å¿ƒæ˜¯åœ¨æ¸¸æˆå…³é—­å‰çš„æœ€åä¸€åˆ»ï¼Œå¼ºåˆ¶ä¿å­˜æ‰€æœ‰è¢«æ ‡è®°ä¸ºâ€œè„â€çš„æ•°æ®ã€‚
# æŠ€æœ¯ç»ç†åˆ¶å®šç ”å‘è®¡åˆ’

# å®æ–½â€œé€€å‡ºæ—¶ä¿å­˜â€åŠŸèƒ½

## 1. é—®é¢˜è¯Šæ–­ (å·²ä¿®æ­£)

é¡¾é—®çš„åˆ†ææ˜¯æ­£ç¡®çš„ã€‚é€šè¿‡ `World.setBlockState` -> `Chunk.setBlockState` -> `chunk.markDirty(true)` çš„è°ƒç”¨é“¾ï¼ŒåŒºå—åœ¨è¢«ä¿®æ”¹åå·²è¢«æ­£ç¡®æ ‡è®°ä¸ºâ€œè„â€ã€‚

çœŸæ­£çš„é—®é¢˜æ˜¯ï¼Œåœ¨æ¸¸æˆå…³é—­æ—¶ï¼Œæ²¡æœ‰ä»»ä½•ä»£ç è°ƒç”¨ `World.saveAllDirtyData()` æ–¹æ³•æ¥ä¿å­˜è¿™äº›è¢«æ ‡è®°çš„åŒºå—ã€‚ç°æœ‰çš„ä¿å­˜é€»è¾‘åªåœ¨åŒºå—è¢«â€œå¸è½½â€ï¼ˆç©å®¶ç§»åŠ¨åˆ°è¿œå¤„ï¼‰æ—¶è§¦å‘ï¼Œè¿™å¯¹äºç©å®¶é€€å‡ºæ—¶ä»ç„¶åŠ è½½çš„åŒºå—æ˜¯æ— æ•ˆçš„ã€‚

## 2. ä¿®å¤æ–¹æ¡ˆ

æˆ‘ä»¬å°†åœ¨æ¸¸æˆä¸»å¾ªç¯çš„ `cleanup` æ–¹æ³•ä¸­æ·»åŠ å¯¹ `world.saveAllDirtyData()` çš„è°ƒç”¨ã€‚è¿™æ˜¯åœ¨ç¨‹åºç»ˆæ­¢å‰ï¼Œç¡®ä¿æ‰€æœ‰æœªä¿å­˜æ•°æ®è¢«å†™å…¥ç£ç›˜çš„æœ€å¯é ä½ç½®ã€‚

### ç›®æ ‡æ–‡ä»¶

- `src/main/java/com/ksptool/mycraft/core/Game.java`

### ä¿®æ”¹ç‚¹

æˆ‘ä»¬å°†åœ¨ `Game.java` çš„ `cleanup` æ–¹æ³•ä¸­ï¼Œåœ¨æ¸…ç†ä¸–ç•Œèµ„æºä¹‹å‰ï¼Œå¢åŠ ä¸€ä¸ªä¿å­˜æ•°æ®çš„æ­¥éª¤ã€‚

**å½“å‰ä»£ç **:

```java
// src/main/java/com/ksptool/mycraft/core/Game.java
private void cleanup() {
    window.cleanup();
    renderer.cleanup();
    if (guiRenderer != null) {
        guiRenderer.cleanup();
    }
    if (world != null) {
        world.cleanup();
    }
}
```

**ä¿®æ”¹åä»£ç **:

```java
// src/main/java/com/ksptool/mycraft/core/Game.java
private void cleanup() {
    if (world != null) {
        world.saveAllDirtyData(); // <--- åœ¨è¿™é‡Œæ·»åŠ ä¿å­˜è°ƒç”¨
        world.cleanup();
    }
    window.cleanup();
    renderer.cleanup();
    if (guiRenderer != null) {
        guiRenderer.cleanup();
    }
}
```

è¿™ä¸ªå•ä¸€çš„ä¿®æ”¹å°†ç¡®ä¿æ‰€æœ‰å·²åŠ è½½ä¸”è¢«ä¿®æ”¹è¿‡çš„åŒºå—å’Œå®ä½“æ•°æ®ï¼Œåœ¨æ¸¸æˆå…³é—­æ—¶éƒ½èƒ½è¢«æ­£ç¡®åœ°ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚



# ç ”å‘å·¥ç¨‹å¸ˆæ±‡æŠ¥

æŸ¥çœ‹ `Game.java` çš„ `cleanup` æ–¹æ³•ï¼Œå‡†å¤‡æ·»åŠ é€€å‡ºæ—¶ä¿å­˜é€»è¾‘ã€‚


[1 tool called]


ä¿®æ”¹ `cleanup` æ–¹æ³•ï¼Œåœ¨æ¸…ç†å‰ä¿å­˜æ‰€æœ‰è„æ•°æ®ã€‚


[2 tools called]


ä¿®æ”¹å·²å®Œæˆã€‚è¿™äº› linter è­¦å‘Šæ˜¯å·²å­˜åœ¨çš„æœªä½¿ç”¨å˜é‡ï¼Œä¸æœ¬æ¬¡ä¿®æ”¹æ— å…³ã€‚


[1 tool called]


ä¿®æ”¹å·²å®Œæˆã€‚å·²åœ¨ `Game.java` çš„ `cleanup()` æ–¹æ³•ä¸­æ·»åŠ  `world.saveAllDirtyData()` è°ƒç”¨ã€‚

ä¿®æ”¹åçš„ä»£ç ï¼š

```446:450:src/main/java/com/ksptool/mycraft/core/Game.java
private void cleanup() {
    if (world != null) {
        world.saveAllDirtyData();
    }
    cleanupWorld();
```

ç°åœ¨ï¼Œå½“æ¸¸æˆé€€å‡ºæ—¶ï¼Œæ‰€æœ‰è¢«æ ‡è®°ä¸ºâ€œè„â€çš„åŒºå—æ•°æ®éƒ½ä¼šè¢«ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œè§£å†³äº†ä¹‹å‰åŒºå—ä¿®æ”¹åœ¨é‡æ–°è¿›å…¥æ¸¸æˆåä¸¢å¤±çš„é—®é¢˜ã€‚



# é¡¾é—®è¯„ä¼°

