<h1 style="color:#883dbc;">项目经理决策</h1>
为多人游戏添加玩家保存机制

<h1 style="color:#ed5b00;">技术经理制定研发计划</h1>

# 服务端玩家退出存档机制修复计划

## 问题分析

当前C-S架构下，`GameServer.onClientDisconnected()` 方法只移除了玩家实体，但没有保存玩家数据。只有在服务器完全关闭时（`ServerLauncher.stopServer()`）才会保存玩家数据，导致玩家退出时数据丢失。

## 修复方案

### 1. 为 ServerWorld 添加 saveName 的 getter 方法

**文件**: `src/main/java/com/ksptool/ourcraft/server/world/ServerWorld.java`

在 `saveName` 字段上添加 `@Getter` 注解，使 `GameServer` 能够获取存档名称。

```55:src/main/java/com/ksptool/ourcraft/server/world/ServerWorld.java
    private String saveName;
```

修改为：

```java
    @Getter
private String saveName;
```

### 2. 在玩家断开连接时保存玩家数据

**文件**: `src/main/java/com/ksptool/ourcraft/server/GameServer.java`

修改 `onClientDisconnected()` 方法，在移除玩家实体之前保存玩家数据。

```156:171:src/main/java/com/ksptool/ourcraft/server/GameServer.java
    public void onClientDisconnected(ClientConnectionHandler handler) {
        ServerPlayer player = handler.getPlayer();
        if (player != null && world != null) {
            log.info("移除断开连接的玩家实体");
            world.removeEntity(player);
            handler.setPlayer(null);
        }
        
        if (serverThread != null) {
            try {
                serverThread.join(1000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
```

修改为：在移除玩家实体之前，先保存玩家数据。需要获取 `saveName` 和 `worldName` 从 `world` 对象。

### 3. 在服务器清理时保存所有在线玩家数据

**文件**: `src/main/java/com/ksptool/ourcraft/server/GameServer.java`

修改 `cleanup()` 方法，在保存世界数据之前，先保存所有在线玩家的数据。

```920:926:src/main/java/com/ksptool/ourcraft/server/GameServer.java
    public void cleanup() {
        stop();
        if (world != null) {
            world.saveAllDirtyData();
            world.cleanup();
        }
    }
```

修改为：在 `world.saveAllDirtyData()` 之前，遍历所有连接的客户端，保存每个玩家的数据。

## 实现细节

- 使用 `SaveManager.getInstance().savePlayer(saveName, playerUUID, player)` 保存玩家数据
- 需要从 `world.getSaveName()` 和 `world.


<h1 style="color:#d36c00;">研发工程师汇报</h1>

查看相关文件，开始实施修复。


[4 tools called]


开始实施修复。


[2 tools called]


修改 `GameServer` 的 `onClientDisconnected()` 和 `cleanup()` 方法。


[5 tools called]


检查是否有编译错误：


[2 tools called]


修复已完成。验证代码是否正确：


[2 tools called]


修复已完成。总结如下：

## 已完成的修复

1. **为 ServerWorld 添加 saveName 的 getter**
    - 在 `ServerWorld.java` 中为 `saveName` 字段添加了 `@Getter` 注解

2. **在玩家断开连接时保存数据**
    - 修改了 `GameServer.onClientDisconnected()` 方法
    - 在移除玩家实体之前，先保存玩家数据到存档

3. **在服务器清理时保存所有在线玩家数据**
    - 修改了 `GameServer.cleanup()` 方法
    - 在保存世界数据之前，遍历所有连接的客户端并保存每个玩家的数据

现在，当玩家退出或服务器关闭时，玩家数据会被正确保存到存档中，与原来的单人模式保持一致。


<h1 style="color:#883dbc;">项目经理验收</h1>

### 不通过 有问题