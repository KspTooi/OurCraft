项目： "MyCraft" 核心架构 - 主菜单和游戏状态管理 (M01M)

背景： 目前，我们的游戏直接进入 Game.loop() 并开始渲染世界。为了支持主菜单、暂停菜单以及未来的存档系统，我们需要引入一个正式的游戏状态管理系统。

目标： 重构核心 Game.java 类，使其能够根据当前 GameState 切换行为（更新和渲染逻辑）。然后，实现一个基本的主菜单界面。

执行计划

第一阶段：游戏状态机 (Game State Machine)

    创建 com.ksptool.ourcraft.sharedcore.enums.GameState.java (新文件):

        创建一个 enum 来定义所有可能的游戏状态。
        Java

          package com.ksptool.ourcraft.core;
          public enum GameState {
              MENU,       // 主菜单界面
              IN_GAME,    // 玩家正在游戏中（世界加载并渲染）
              PAUSED,     // 游戏暂停（世界不更新，显示暂停菜单）
              LOADING     // 正在加载/生成世界
          }

    修改 com.ksptool.ourcraft.client.Game.java：

        添加 private GameState currentState = GameState.MENU; 字段。

        重构 run() 方法：

            run() 方法的逻辑将主要是一个大的 switch 语句，根据 currentState 来调用不同的 update 和 render 逻辑。

第二阶段：基础 UI 渲染器

    创建 com.ksptool.ourcraft.client.rendering.GuiRenderer.java (新类):

        这是一个专门用于渲染 2D 元素的渲染器，它不需要复杂的 3D 摄像机或世界矩阵。

        它只需要一个正交投影 (Orthographic Projection) 着色器。

        关键方法： public void renderQuad(float x, float y, float width, float height, Vector4f color) 用于绘制按钮的背景。

        （可选/待定）： 准备未来字体渲染的接口。

第三阶段：实现主菜单逻辑

    修改 com.ksptool.ourcraft.client.Game.java：

        添加 public void startGame() 方法：

            该方法负责初始化 World（如果它还不存在）。

            将 currentState 设置为 GameState.IN_GAME。

        在 Game.update() 中：

            使用 switch (currentState) 语句：

                case IN_GAME: 调用 world.update() 和处理玩家输入。

                case MENU: 处理菜单输入（例如，检测鼠标点击按钮）。

        在 Game.render() 中：

            使用 switch (currentState) 语句：

                case IN_GAME: 调用 renderer.render(world, camera)。

                case MENU: 调用 guiRenderer.renderMenu()。

    创建 com.ksptool.ourcraft.client.gui.MainMenu.java (新类):

        这是一个简单的类，管理按钮的位置和逻辑。

        它需要一个 render(GuiRenderer guiRenderer) 方法来绘制按钮。

        它需要一个 handleInput(Input input) 方法来处理“开始游戏”和“退出游戏”按钮的点击事件，并调用 game.startGame() 或 Window.shouldClose()。

# MyCraft 游戏状态管理和主菜单系统实现计划

## 阶段1：游戏状态机基础

### 1.1 创建GameState枚举

- 文件：`src/main/java/com/ksptool/mycraft/core/GameState.java`
- 定义状态：`MAIN_MENU`, `SINGLEPLAYER_MENU`, `CREATE_WORLD`, `IN_GAME`, `PAUSED`, `LOADING`

### 1.2 重构Game.java核心逻辑

- 添加 `private GameState currentState = GameState.MAIN_MENU;`
- 修改 `init()` 方法：移除直接创建世界和玩家的逻辑，默认进入主菜单
- 重构 `update()` 方法：使用if-return模式根据currentState调用不同更新逻辑
- 重构 `render()` 方法：使用if-return模式根据currentState调用不同渲染逻辑
- 添加 `startGame(String worldName)` 方法：初始化世界和玩家，切换到IN_GAME状态
- 添加 `loadWorld(String worldName)` 方法：加载已保存的世界
- 添加 `createNewWorld(String worldName)` 方法：创建新世界

## 阶段2：GUI渲染系统

### 2.1 创建GuiRenderer类

- 文件：`src/main/java/com/ksptool/mycraft/rendering/GuiRenderer.java`
- 基于现有的UI着色器系统（ui_vertex.glsl/ui_fragment.glsl）
- 实现方法：
    - `renderQuad(float x, float y, float width, float height, Vector4f color)` - 渲染矩形
    - `renderButton(float x, float y, float width, float height, String text, boolean hovered)` - 渲染按钮
    - `renderText(float x, float y, String text, float scale)` - 基础文本渲染（使用简单位图或字符纹理）
- 管理正交投影和屏幕坐标转换

### 2.2 创建文本渲染系统（简化版）

- 文件：`src/main/java/com/ksptool/mycraft/rendering/TextRenderer.java`
- 使用简单的字符纹理图集或位图字体
- 实现基本的文本绘制功能（用于按钮标签和菜单标题）

## 阶段3：菜单系统实现

### 3.1 创建MainMenu类

- 文件：`src/main/java/com/ksptool/mycraft/gui/MainMenu.java`
- 功能：
    - 渲染主菜单背景（可选：简单的渐变或纹理）
    - 渲染按钮："单人游戏"、"选项"、"退出游戏"
    - `handleInput(Input input, int windowWidth, int windowHeight)` - 处理鼠标点击
    - `render(GuiRenderer guiRenderer, TextRenderer textRenderer, int windowWidth, int windowHeight)` - 渲染菜单

### 3.2 创建SingleplayerMenu类

- 文件：`src/main/java/com/ksptool/mycraft/gui/SingleplayerMenu.java`
- 功能：
    - 显示世界列表（从WorldManager获取）
    - "创建新世界"按钮
    - "返回"按钮
    - 世界选择功能（点击世界名称加载）
    - 支持滚动（如果世界列表很长）

### 3.3 创建CreateWorldMenu类

- 文件：`src/main/java/com/ksptool/mycraft/gui/CreateWorldMenu.java`
- 功能：
    - 世界名称输入框（简单的文本输入处理）
    - "创建"按钮
    - "取消"按钮
    - 使用StringUtils.isBlank()验证世界名称

## 阶段4：世界管理系统

### 4.1 创建WorldManager类

- 文件：`src/main/java/com/ksptool/mycraft/world/WorldManager.java`
- 功能：
    - `getWorldList()` - 获取所有已保存的世界列表
    - `saveWorld(World world, String worldName)` - 保存世界数据到文件系统
    - `loadWorld(String worldName)` - 从文件系统加载世界
    - `worldExists(String worldName)` - 检查世界是否存在
    - `deleteWorld(String worldName)` - 删除世界（可选）
- 世界数据存储位置：`saves/` 目录
- 世界元数据：JSON格式存储世界名称、种子、创建时间等

### 4.2 修改World类以支持保存/加载

- 添加 `saveToFile(String path)` 方法：保存区块数据
- 添加 `loadFromFile(String path)` 方法：加载区块数据
- 添加 `getWorldName()` 和 `setWorldName(String name)` 方法
- 添加世界种子存储

### 4.3 修改WorldGenerator以支持种子

- 添加种子参数支持，确保相同种子生成相同世界

## 阶段5：输入处理和状态切换

### 5.1 扩展Input类（如需要）

- 添加 `getMousePosition()` 方法（如果还没有）
- 确保鼠标解锁/锁定状态切换正常工作

### 5.2 实现状态切换逻辑

- 在Game类中实现状态之间的平滑切换
- 菜单状态时解锁鼠标，游戏状态时锁定鼠标
- ESC键处理：游戏中按ESC进入暂停菜单，暂停菜单中按ESC返回游戏

## 实现细节

### 代码规范遵循

- 使用if-return/if-continue/if-throw短路模式
- 不使用switch和else
- 字符串判断使用StringUtils.isBlank()/isNotBlank()
- 所有响应使用中文

### 文件结构

```
src/main/java/com/ksptool/mycraft/
├── core/
│   ├── Game.java (修改)
│   ├── GameState.java (新建)
│   ├── Input.java (可能需要扩展)
│   └── Window.java
├── gui/
│   ├── MainMenu.java (新建)
│   ├── SingleplayerMenu.java (新建)
│   └── CreateWorldMenu.java (新建)
├── rendering/
│   ├── GuiRenderer.java (新建)
│   ├── TextRenderer.java (新建)
│   └── HotbarRenderer.java (已存在，参考)
└── world/
    ├── World.java (修改，添加保存/加载)
    ├── WorldManager.java (新建)
    └── WorldGenerator.java (修改，添加种子支持)
```

### 依赖检查

- 确认项目已包含org.apache.commons.lang3依赖（用于StringUtils）
- 如无，需要在pom.xml或build.gradle中添加

开始实施计划。先添加必要的依赖，然后按顺序完成所有待办事项。


[3 tools called]


开始实施计划。先添加依赖并扩展 Input 类，然后创建所需的新类。


[3 tools called]


创建 GUI 渲染系统：先创建 TextRenderer，再创建 GuiRenderer。


[3 tools called]


创建 WorldManager 类：


[2 tools called]


修改 World 类以支持保存/加载和种子：


[2 tools called]


修改 World 类以支持保存/加载和种子：


[4 tools called]


创建菜单类：


[3 tools called]


修复 GuiRenderer，然后重构 Game.java：


[2 tools called]


重构 Game.java 以集成所有菜单和状态管理：


[1 tool called]


修复 MainMenu 中的问题：


[5 tools called]


修复 MainMenu 的 render 方法：


[2 tools called]


修复 Game.java 中的一个小问题：


[2 tools called]


确保 World 类在创建时设置默认种子：


[2 tools called]


所有代码已实现。总结已完成的工作：

## 已完成的工作

1. **创建了 GameState 枚举** - 定义了所有游戏状态
2. **重构了 Game.java** - 实现了完整的状态管理系统，使用 if-return 模式
3. **创建了 GuiRenderer 类** - 实现了基础 UI 渲染功能
4. **创建了 TextRenderer 类** - 实现了基础文本渲染功能
5. **创建了 MainMenu 类** - 实现了主菜单界面
6. **创建了 WorldManager 类** - 实现了世界保存/加载功能
7. **修改了 World 类** - 添加了保存/加载方法和种子支持
8. **创建了 SingleplayerMenu 类** - 实现了世界选择界面
9. **创建了 CreateWorldMenu 类** - 实现了世界创建界面
10. **集成了所有菜单** - 在 Game 类中实现了完整的状态切换流程

## 主要功能

- 游戏状态机：支持主菜单、单人游戏菜单、创建世界、游戏中、暂停等状态
- 主菜单系统：类似 Minecraft 的主菜单界面
- 世界管理：创建、保存、加载世界
- GUI 渲染系统：基于正交投影的 UI 渲染
- 文本渲染：基础文本显示功能
- 输入处理：鼠标点击和键盘输入处理

所有代码遵循了用户规则：
- 使用 if-return/if-continue 短路模式
- 不使用 switch 和 else
- 使用 StringUtils.isBlank() 进行字符串判断
- 所有响应使用中文

代码已准备就绪，可以运行测试。