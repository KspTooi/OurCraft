# **研发日志 1.2F2：区块租约系统与逻辑统一**

大家好，  
在 1.2F1 中，我们完成了物理引擎精度的“核聚变”升级，让世界变得无限广阔。今天，在 1.2F2 版本中，我们将目光投向了服务端的“大脑”——**资源管理与逻辑调度**。  
我们引入了一个现代化的**区块租约系统 (Chunk Lease System)**，并开始着手统一服务端那散落在各处的逻辑碎片。这不仅是为了性能，更是为了让我们的世界运转得更加井井有条。

## **一、区块租约系统：签署资源的“使用权”**

**最重要的一点：这些所有工作，都是为了 FlexChunk 实装做铺垫。**  
FlexChunk 作为下一代高性能区块，其生命周期管理极其严苛。没有租约系统的精确控制，FlexChunk 就会陷入混乱的加载/卸载循环；没有统一的 Action 逻辑，FlexChunk 的高并发特性就无处施展。  
可以说，本版本 (1.2F2) 是 FlexChunk 降临前最后的“净土行动”。  
在之前的版本（尤其是 Flex 组件实装前），区块的加载和卸载逻辑相对简单，甚至可以说是“随性”的。

### **我们面临的问题：**

1. **加载颠簸 (Thrashing)**：玩家在区块边界反复横跳，导致区块不断被卸载、立刻又被加载，硬盘 IO 苦不堪言。  
2. **僵尸区块**：有些区块虽然没有玩家在看，但因为某些残留的引用或逻辑错误，一直驻留在内存中，直到服务器重启。  
3. **算力浪费**：所有加载的区块都在进行全量的物理模拟和 Tick 更新，哪怕那里根本没有玩家，也没有需要运作的机器。

### **解决方案：租约 (Lease)**

我们抛弃了简单的“引用计数”或“令牌”概念，引入了更具契约精神的 **区块租约 (FlexChunkLease)**。现在，任何系统想要保持一个区块加载，都必须向 FlexChunkLeaseService 签署一份“租约”。

* **有租约即存活**：只要一个区块持有一份或多份有效的（未过期的）租约，它就会被保留在内存中。  
* **租约类型**：  
  * **PLAYER (玩家租约)**：这是最动态的租约。当玩家在世界中移动时，系统会计算其视距范围，并为范围内的所有区块签发短期租约。  
    * **动态续约**：只要玩家还停留在该区域，FlexChunkLeaseService 就会不断为这些区块“续租”。  
    * **自然过期**：当玩家离开，不再续约后，租约内的 TTL (Time To Live) 会随时间自然耗尽。这提供了一个优雅的“缓冲期”，防止玩家在区块边界徘徊时造成频繁的 IO 抖动。  
  * **SERVER (服务器租约)**：用于出生点保护区、或是管理员圈定的永久加载区。这类租约通常被标记为 Permanent（永久），除非手动撤销，否则区块永远不会卸载。  
* **租约等级 (Lease Level)**：  
  * 我们为租约引入了 **等级 (Level)** 概念（HIGH, MEDIUM, LOW）。  
  * 这为未来实装细粒度的逻辑分级铺平了道路：例如，持有 HIGH 等级租约的区块会执行完整的实体和方块 Tick；而仅持有 LOW 等级租约的区块（如视距边缘）可能只进行基本的数据维护，不消耗宝贵的物理算力。

通过这套系统，我们不仅解决了内存泄漏，更实现了算力的精细化分配——CPU 资源将只流向真正签了“合同”的地方。

## **二、统一服务端 Action：重塑逻辑管线**

长期以来，OurCraft 服务端的逻辑一直处于一种“精神分裂”的状态。

### **现状分析**

* **ServerWorldExecutionUnit (SWEU)**：作为线程的宿主，它负责了 while 循环、网络包的发送、视口的更新，甚至还插手了部分事件处理。  
* **ServerWorld**：作为数据容器，它却又承担了物理模拟、实体更新和时间推进的职责。

这种逻辑的割裂导致代码难以维护。有时候你想找“玩家移动在哪里处理”，却发现一部分在 SWEU 里解包网络数据，另一部分在 ServerWorld 里更新坐标，还有一部分在 Entity 类里计算碰撞。

### **变革方向：标准化 Action**

在 1.2F2 中，我们虽然还未完全完成代码迁移，但已经确立了全新的 **Server Action Pipeline**。我们将原本杂乱的逻辑梳理为清晰的线性工序。

### **为什么这很重要？**

通过将逻辑封装为独立的 Action，我们解耦了“做什么”和“怎么做”。这意味着：

* **可测试性**：我们可以单独测试 PhysicsAction 而不需要启动整个网络层。  
* **扩展性**：未来插件想要插入自定义逻辑，只需要在这个流水线中注册一个新的 Action。  
* **并行化**：清晰的阶段划分让我们更容易识别哪些步骤可以并行执行（例如，不同世界的 PhysicsAction 可以分配给不同线程）。

## **下一步计划**

1.2F2 为服务端逻辑的标准化迈出了第一步。在接下来的版本中，我们将彻底完成 SWEU 的瘦身工作，让它回归纯粹的“执行单元”角色，而将真正的游戏逻辑完全托管给这套 Action 管线。  
感谢大家的支持，让我们继续构建这个世界！！