# 研发日志 1.2F2：区块票据系统与逻辑统一

大家好，

在 1.2F1 中，我们完成了物理引擎精度的“核聚变”升级，让世界变得无限广阔。今天，在 1.2F2 版本中，我们将目光投向了服务端的“大脑”——**资源管理与逻辑调度**。

我们引入了一个现代化的**区块令牌系统 (Chunk Token System)**，并开始着手统一服务端那散落在各处的逻辑碎片。这不仅是为了性能，更是为了让我们的世界运转得更加井井有条。

## 一、区块令牌系统：给加载一个“理由”

**最重要的一点：这些所有工作，都是为了 FlexChunk 实装做铺垫。**

FlexChunk 作为下一代高性能区块，其生命周期管理极其严苛。没有令牌系统的精确控制，FlexChunk 就会陷入混乱的加载/卸载循环；没有统一的 Action 逻辑，FlexChunk 的高并发特性就无处施展。

可以说，本版本 (1.2F2) 是 FlexChunk 降临前最后的“净土行动”。

在之前的版本（尤其是 Flex 组件实装前），区块的加载和卸载逻辑相对简单，甚至可以说是“随性”的。

### 我们面临的问题：
1.  **加载颠簸 (Thrashing)**：玩家在区块边界反复横跳，导致区块不断被卸载、立刻又被加载，硬盘 IO 苦不堪言。
2.  **僵尸区块**：有些区块虽然没有玩家在看，但因为某些残留的引用或逻辑错误，一直驻留在内存中，直到服务器重启。
3.  **算力浪费**：所有加载的区块都在进行全量的物理模拟和 Tick 更新，哪怕那里根本没有玩家，也没有需要运作的机器。

### 解决方案：令牌 (Token)

我们引入了 **区块令牌 (FlexChunkToken)** 概念。现在，任何系统想要保持一个区块加载，都必须出示一个“令牌”。

*   **没有令牌 = 等待 TTL 耗尽**：如果一个区块身上没有任何有效的令牌，系统不会立即卸载它，而是等待其 TTL（Time To Live）耗尽。
    *   在 FlexServerChunk 中，当没有令牌（Token）时，每个 Action 周期会减少 TTL。
    *   只有当 TTL 归零时，区块才会真正被卸载。这提供了一个“缓冲期”，防止玩家在区块边界徘徊时造成频繁的 IO 抖动。
*   **令牌类型**：
    *   **PLAYER (玩家令牌)**：最常见的令牌。当玩家站在某个位置，周围 `RenderDistance` 范围内的区块会自动获得这个令牌。
    *   **SERVER (服务器令牌)**：用于出生点保护区、或是管理员圈定的永久加载区，或者是系统临时任务（如生成结构）使用的令牌。
*   **令牌优先级 (Token Priority)**：
    *   目前我们实现了基础的 **优先级 (Priority)** 机制，用于区分不同来源的加载请求（如玩家加载优先于系统预加载）。
    *   虽然尚未实装细粒度的逻辑分级（如 Entity Ticking vs Block Ticking），但这套优先级系统已经足以支撑我们目前的按需加载需求，确保关键区块始终优先被处理。

通过这套系统，我们不仅解决了内存泄漏，更实现了算力的精细化分配——CPU 资源将只流向真正需要它的地方。

## 二、统一服务端 Action：重塑逻辑管线

长期以来，MyCraft 服务端的逻辑一直处于一种“精神分裂”的状态。

### 现状分析
*   **ServerWorldExecutionUnit (SWEU)**：作为线程的宿主，它负责了 `while` 循环、网络包的发送、视口的更新，甚至还插手了部分事件处理。
*   **ServerWorld**：作为数据容器，它却又承担了物理模拟、实体更新和时间推进的职责。

这种逻辑的割裂导致代码难以维护。有时候你想找“玩家移动在哪里处理”，却发现一部分在 SWEU 里解包网络数据，另一部分在 ServerWorld 里更新坐标，还有一部分在 Entity 类里计算碰撞。

### 变革方向：标准化 Action

在 1.2F2 中，我们虽然还未完全完成代码迁移，但已经确立了全新的 **Server Action Pipeline**。我们将原本杂乱的逻辑梳理为清晰的线性工序：

1.  **TimeAction**：推进世界时间，计算日夜循环。
2.  **EventPollAction**：从 EventBus 拉取所有积压事件，并按“玩家输入”和“系统事件”进行分类。
3.  **PlayerInputAction**：专心处理玩家的键盘移动、鼠标视角和交互请求。
4.  **WorldLogicAction**：执行计划任务、天气变化等全局逻辑。
5.  **PhysicsAction**：统一的物理模拟阶段。所有实体（包括玩家）的位置更新、碰撞检测都在这里发生。
6.  **SpatialMaintenanceAction**：检查实体是否跨越了区块边界，更新 `ChunkTokenService`（这正是令牌系统发挥作用的地方）。
7.  **LifecycleAction**：清理死亡实体，回收失效资源。

### 为什么这很重要？
通过将逻辑封装为独立的 Action，我们解耦了“做什么”和“怎么做”。这意味着：
*   **可测试性**：我们可以单独测试 `PhysicsAction` 而不需要启动整个网络层。
*   **扩展性**：未来插件想要插入自定义逻辑，只需要在这个流水线中注册一个新的 Action。
*   **并行化**：清晰的阶段划分让我们更容易识别哪些步骤可以并行执行（例如，不同世界的 PhysicsAction 可以分配给不同线程）。

## 下一步计划

1.2F2 为服务端逻辑的标准化迈出了第一步。在接下来的版本中，我们将彻底完成 SWEU 的瘦身工作，让它回归纯粹的“执行单元”角色，而将真正的游戏逻辑完全托管给这套 Action 管线。

感谢大家的支持，让我们继续构建这个世界！！

