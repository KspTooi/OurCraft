# 1.2E_3 研发日志：重塑数据基石——统一归档与混合存储架构

大家好，

在之前的研发日志中，我们探讨了 ECS 架构的重构以及服务端线程模型的演进。今天，我们将目光投向引擎最底层、也是最关乎数据安全的部分——**数据持久化系统（Save System）**。

经过深思熟虑的评估，我们决定对现有的存档机制进行一次彻底的升级，引入全新的 **`Archive`（归档）** 组件系列。这一改动旨在解决旧版系统在面对未来海量数据时的局限性，并为多人游戏和多世界架构打下坚实的“工业级”地基。

### **一、 从文件丛林到统一数据库**

在目前的版本中，我们的存档结构相对原始：世界列表、玩家数据、调色板信息分别散落在不同的 JSON 文件中。这种“文件丛林”在单人游戏初期尚能应付，但当我们试图构建一个支持多世界并行、多玩家实时交互的系统时，文件 I/O 的瓶颈和事务安全性问题便会逐渐浮现。

为了解决这个问题，我们决定引入数据库 **H2 Database** 作为存档的核心引擎。

现在的“存档”不再是一堆散乱的文件，而是一个结构严谨的数据库系统。我们将数据管理权收归于统一的 `ArchiveManager`，它将负责维护以下核心数据表：

* **归档元数据 (Archive Info)**：记录存档的版本信息与时间戳，确保数据升级的兼容性。
* **世界索引 (World Index)**：统一管理所有维度的种子、生成时间与运行状态，替代了旧版分散的 JSON 配置。
* **玩家索引 (Player Index)**：将原本分散在文件夹中的玩家 UUID 数据统一入库，支持更高效的查询与状态同步。
* **全局调色板 (Global Palette)**：确保方块 ID 映射在数据库层面的绝对一致性，防止因 ID 错乱导致的世界崩坏。

这一转变意味着我们的数据管理从“手动维护文件”进化到了“系统化索引”，大大提升了数据的可靠性与查询效率。

### **二、 架构调整：确立 SCA + DB 的混合存储模式**

细心的开发者可能记得，在早期的 1.2E 计划中，我们曾设想使用 `.sce` (Super Chunk Entity) 二进制文件来存储实体数据。但在实际的架构验证中，我们重新评估了这一方案。

我们发现，**地形数据**与**实体数据**在读写特性上存在本质的区别：
* **地形（方块）**是大块且相对静态的数据，非常适合使用高压缩率的文件流（SCA）进行存储。
* **实体（玩家与生物）**则是细碎且高频变动的数据。它们的位置、血量每时每刻都在变化，如果继续沿用文件存储，频繁的寻址与覆写将带来巨大的性能损耗。

因此，我们决定**放弃 .sce 文件方案**，转而采用 **SCA（文件存地形）+ DB（数据库存实体）** 的混合架构。

为此，我们设计了全新的实体存储表结构：它以区块坐标为索引，直接存储该区块内所有实体的二进制快照。这种设计充分利用了数据库在处理“行级更新”上的天然优势，让我们能够高效地更新特定区域的实体状态，而无需重写整个文件。

### **三、 过渡策略：新架构与旧数据的桥接**

虽然我们的终极目标是使用高效的 `BitStorage`（位存储）来处理内存中的区块数据，但为了不阻塞存档系统的重构进度，我们采取了一种务实的**“新瓶装旧酒”**过渡策略。

在当前阶段，我们将优先实装整套 `Archive` 数据库架构（包括 SQL 表结构、连接池管理与数据访问层）。暂时的，我们将这套先进的存储系统对接现有的 `int[][][]` 内存数据结构。

这一策略确保了我们可以立即验证数据库读写流程的稳定性与性能。一旦底层的 `BitStorage` 开发完成，我们只需在序列化层进行无缝切换，而无需再次改动上层架构。

### **结语**

这次 `Archive` 组件的实装，标志着我们的引擎从原型阶段的数据读写，正式迈向了成熟的数据管理。通过结合文件系统的高吞吐量与数据库的事务管理能力，我们确信这套混合架构将能够从容应对未来更加庞大和复杂的游戏世界。

感谢大家的支持，让我们继续建设这个世界。