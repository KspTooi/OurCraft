<h1 style="color:#883dbc;">项目经理决策</h1>

上次的修复依然无效 玩家退出以后再加入服务器 他的位置又回到出生点了 检查是否是别的问题导致的

<h1 style="color:#ed5b00;">技术经理评估</h1>

好的，我已经审查了代码，找到了问题所在。

问题根源

您之前的修复在玩家退出时正确地保存了数据。但问题出在玩家重新加入服务器的逻辑上。

在 src/main/java/com/ksptool/ourcraft/server/GameServer.java 的 handleRequestJoinServer 方法中，服务器每次处理玩家的加入请求时，都会执行以下操作：

ServerPlayer newPlayer = new ServerPlayer(world);

这行代码会创建一个 全新的 ServerPlayer 实例，并为其分配一个 全新的、随机的 UUID。

然后，服务器为这个全新的玩家计算一个出生点，并将其放置在该位置。

因此，服务器完全没有尝试去加载该玩家之前保存的数据，因为它是通过 UUID 来识别玩家存档的，而每次登录的 UUID 都是新的。

修复计划

为了解决这个问题，我们需要在服务器端建立一个玩家名 (playerName) 到 UUID 的持久化映射关系。这样，当一个玩家重新连接时，我们可以通过他的名字找到他上一次游戏的 UUID，从而加载正确的存档数据。

具体的修复步骤如下：

扩展 SaveManager 以管理玩家身份

在 SaveManager 中添加逻辑，用于在存档目录中读写一个 player_uuids.json 文件。该文件将存储玩家名到 UUID 的映射。

创建一个新方法，例如 getOrCreatePlayerUUID(String saveName, String playerName)。此方法将：

查找给定玩家名的 UUID。

如果找不到（即新玩家），则创建一个新的 UUID，保存映射关系，并返回新的 UUID。

如果找到了，则直接返回已有的 UUID。

修改 GameServer 的玩家加入逻辑

修改 handleRequestJoinServer 方法。

当玩家请求加入时，调用 SaveManager 的新方法，用玩家名获取其持久化的 UUID。

使用获取到的 UUID 去加载玩家的 .index 存档文件。

如果存档存在，则从存档中恢复玩家的位置、物品栏等信息。

如果存档不存在（新玩家），才为他计算新的出生点。


<h1 style="color:#883dbc;">项目经理决策</h1>

我们先在客户端写死一个玩家名 KspTooi(未来允许修改) 然后执行这个操作。请你制定完整计划


<h1 style="color:#ed5b00;">技术经理制定研发计划</h1>

# 修复玩家重连位置重置问题

## 总体方案

当前玩家每次重连都会被当作一个全新的玩家，因为服务器无法将新的连接与旧的玩家数据关联起来。本计划将通过以下步骤解决此问题：

1.  **客户端改造**：在客户端发起连接请求时，写死玩家名 `KspTooi`。
2.  **服务端改造**：在服务端实现一个持久化的 `玩家名 -> UUID` 映射机制。当玩家连接时，服务端将使用其玩家名查找对应的 `UUID`，并加载该 `UUID` 的存档数据。如果玩家是第一次加入，则为其创建一个新的 `UUID` 并保存映射关系。

## 详细计划

### 阶段一：客户端固定玩家名

**目标**：修改客户端代码，使其在连接服务器时始终使用 `KspTooi` 作为玩家名。

-   **文件**: `src/main/java/com/ksptool/ourcraft/client/network/ServerConnection.java`
-   **操作**: 定位到 `connect` 方法中创建 `RequestJoinServerNDto` 的位置，将玩家名参数硬编码为 `"KspTooi"`。
```java
// 找到这行代码
RequestJoinServerNDto requestPacket = new RequestJoinServerNDto("1.0", "Player" + System.currentTimeMillis());

// 将其修改为
RequestJoinServerNDto requestPacket = new RequestJoinServerNDto("1.0", "KspTooi");
```


### 阶段二：服务端实现玩家UUID持久化

**目标**：改造 `SaveManager`，使其能够保存和读取 `玩家名 -> UUID` 的映射关系。

-   **文件**: `src/main/java/com/ksptool/ourcraft/server/world/save/SaveManager.java`
-   **操作**:

    1.  在 `SaveManager` 中添加一个新的 `player_uuids.json` 文件来管理每个存档中的玩家身份。
    2.  添加一个新方法 `getOrCreatePlayerUUID(String saveName, String playerName)`。此方法会：

        -   根据 `saveName` 和 `playerName` 查找对应的 `UUID`。
        -   如果找到，则返回该 `UUID`。
        -   如果找不到（新玩家），则生成一个新的 `UUID`，将 `(playerName, newUUID)` 的映射关系存入 `player_uuids.json`，然后返回这个新 `UUID`。

    1.  添加内存缓存，避免频繁读写磁盘。

### 阶段三：服务端加载玩家数据

**目标**：改造 `GameServer`，使其在处理玩家加入请求时，使用新的 `UUID` 持久化机制来加载玩家数据。

-   **文件**: `src/main/java/com/ksptool/ourcraft/server/GameServer.java`
-   **操作**:

    1.  修改 `handleRequestJoinServer` 方法。
    2.  当收到玩家加入请求时，调用 `SaveManager.getOrCreatePlayerUUID()` 获取玩家的持久化 `UUID`。
    3.  使用该 `UUID` 创建 `ServerPlayer` 实例。
    4.  尝试使用该 `UUID` 从 `SaveManager` 加载玩家的 `.index` 存档文件。
    5.  如果存档存在，则从中恢复玩家的位置、朝向、物品栏等数据。
    6.  如果存档不存在（新玩家），则执行原有的逻辑，为其计算一个新的出生点。

这个计划将确保玩家的身份能够被服务器持久化记录，从而在重连时恢复其之前的游戏进度。


<h1 style="color:#0093ed;">4.顾问评估</h1>


<h1 style="color:#d36c00;">5.研发工程师汇报</h1>


<h1 style="color:#0093ed;">6.顾问评估</h1>


<h1 style="color:#883dbc;">7.项目经理验收</h1>

