# **V1.1 研发总结：架构的“野蛮”演进与技术债**

在Version 1.0中，我们实现了一个结构清晰、功能完备的单机体素世界。而Version 1.1，则是MyCraft项目历史上**最激进、也最混乱**的迭代周期。  
本阶段的核心命题只有一个：**不惜一切代价实现C/S架构分离**。  
我们这群经验丰富的“Web后端工程师”，在游戏开发的新领域中，以一种近乎“野蛮施工”的方式，强行推进了引擎的演进。这种“胡乱重构”虽然表面上达成了目标，但也为V1.2留下了大量的技术债，亟待“彻底净化”。

## **一、 “大扫除” (1.1A \- 1.1I)**

V1.1的开端，源于一份“触目惊心”的代码质量评估报告（1\_1A）。报告明确指出，随着V1.0的快速迭代，World.java等核心类已演变为“上帝类”(God Class)，技术债务已达警戒线。  
在进入C/S架构的未知水域前，我们启动了代号为“7条军规”的重构冲刺（1\_1B），以清偿V1.0的“有序债务”。

* **基础净化 (1.1C, 1.1D, 1.1E)**：我们迅速实施了Lombok、SLF4J、卫语句和常量提取，这极大提升了代码库的可读性和可维护性。
* **核心架构手术 (1.1F, 1.1G, 1.1H, 1.1I)**：我们同样取得了关键进展：
    * 实现了“注册表模式”(Registry Pattern)（1\_1G），为未来的Mod系统奠定了基础。
    * 通过BlockFace枚举，消灭了Chunk.java中的大量重复渲染代码（1\_1H）。
    * **最关键的是**，我们成功拆分了“上帝类”World.java（1\_1I），使其“无头化”(Headless)，不再依赖任何OpenGL。

然而，这场“大扫除”仅仅是风暴前的平静。我们很快就将V1.0的“有序债务”，替换为了V1.1的“混沌债务”。

## **二、 引擎体验优化 (1.1J, 1.1K, 1.1L)**

在重构核心的同时，我们修复了两个V1.0遗留的重大体验问题。

* **引入WorldTemplate（维度）（1\_1J）**：引入了WorldTemplate（世界模板）的概念，将世界的物理规则（如ticksPerSecond, gravity）从代码中解耦到配置中。
* **解耦TPS与FPS（1\_1K, 1\_1L）**：WorldTemplate的引入（固定20 TPS）立刻暴露了V1.0的耦合问题。我们通过“摄像机插帧”技术（1\_1K）解决了视觉卡顿，并通过重构物理引擎、调整摩擦力为0.6f（1\_1L），解决了“太空滑步”问题，恢复了“跟手”的体验。

这两项修复是V1.1中为数不多的、清晰且必要的工程优化。

## **三、 C/S架构的“野蛮”推进 (1.1N \- 1.1Z)**

V1.1的下半场，是整个项目“失控”的开始。**从单机到多人的改造**（1\_1N）是一个正确的战略方向，但我们的战术执行（“胡乱重构”）是混乱的、缺乏规划的，并直接导致了后续的“地狱试炼”。

### **1\. 架构哲学**

在重构的泥潭中，我们还是做出了几个至关重要的、“幸存”下来的正确决策：

* **“红旗”警示（1\_1S）**：GameServer线程尝试调用OpenGL函数的FATAL ERROR（1\_1S），这个“红旗”铁证如山地表明我们的分离是何等混乱。它**迫使**我们做出了最彻底的分离：服务端**绝不能**知道“顶点”或“纹理”是什么。
* **彻底分离（1\_1T \- 1\_1W）**：基于“红旗”警示，我们否决了BaseWorld的“继承陷阱”，选择了最困难但也最正确的道路：为World、Chunk、Player、Entity、Inventory等所有核心动态组件创建完全独立的Server（权威）和Client（预测）版本。
* **“魔法开关”（1\_1X\_1）**：面对Block（方块）可能带来的“类爆炸”问题，我们设计了SharedWorld.isClientSide()这一“魔法开关”。这允许我们在**一个** SharedBlock类中编写两端逻辑，是V1.1混乱中最优雅的架构设计。

### **2\. “黄金技术栈”**

1\_1M中，我们将项目升级到了**JDK 21**。  
在1\_1X\_3的网络选型中，我们放弃了Netty的异步心智负担，选择了完美契合团队（Web后端）背景的“黄金技术栈”：

1. **JDK 21 虚拟线程（VT）**
2. **原生Socket**
3. **Kryo二进制序列化**

这个技术栈是V1.1中**最成功**的决策。它极大地降低了心智负担，使我们这群“Web后端”工程师能在后续的“地狱试炼”中，以最熟悉的方式（同步编程）快速定位和修复BUG。

### **3\. C/S重构的恶果 (1.1O \- 1.1X\_12)**

V1.1的后半段，研发日志中充斥着连续的\*\*“不通过\! 有问题”\*\*。**这正是“胡乱重构”的直接后果。** 我们的“地狱试炼”并非教科书式的攻坚，而是**在失控的边缘疯狂“打补丁”**。我们像在泥潭中跋涉，每解决一个BUG，就踩出两个新的技术债。

* **“空白世界” (1\_1O \- 1\_1R)**：
    * **问题**：客户端黑屏、无法操作。
    * **根源**：EventQueue 的 C/S 竞态条件。C/S端互相“偷走”对方的事件。
    * **补丁**：分离 C2S/S2C 队列。**（留下的债务：EventQueue本身就是单机硬改的产物，应被网络协议栈彻底取代）**
* **“地底视角” (1\_1X\_7, 1\_1X\_8)**：
    * **问题**：玩家卡在地底，看到浮空区块。
    * **根源**：两个并发BUG。1. **服务端竞态条件**：玩家实体在区块（地面）生成**之前**就已添加到世界。 2\. **客户端初始化BUG**：客户端的previousPosition默认为(0,0,0)，导致插值计算错误。
    * **补丁**：调整了服务端生成顺序；在setPosition时强行同步previousPosition。**（留下的债务：客户端状态初始化流程依然混乱）**
* **“客户端预测” (1\_1X\_9)**：
    * **问题**：网络延迟导致操作“粘滞”。
    * **根源**：客户端发送的是“位置”而非“输入”。
    * **补丁**：实现了“客户端预测、服务端权威”模型，客户端发送PlayerInputStateNDto。**（留下的债务：C/S端的物理代码（ClientLivingEntity）是粗暴的“复制-粘贴”，存在大量重复代码，V1.2必须净化）**
* **“网络风暴” (1\_1X\_10, 1\_1X\_11)**：
    * **问题**：客户端CPU 100%，收到海量位置同步包。
    * **根源**：服务端主循环while(true)不受控制，并在“追帧”时发送了所有中间计算包。
    * **补丁**：实现了“固定步长”（20 TPS），并分离tick()(模拟)和sendNetworkUpdates()(同步)。**（留下的债务：服务器主循环依然臃肿，GameServer类承担了过多职责）**
* **“幽灵拉扯” (1\_1X\_12)**：
    * **问题**：玩家被“拉扯”到(0,0,0)或其它玩家位置。
    * **根源**：一个极其隐蔽的BUG。getEntityIdForPlayer在玩家未完全加入时错误地返回了0（代表“玩家自己”）。
    * **解决**：**“很好\!\!\!”** 我们通过返回-1（无效ID）解决了这个BUG，网络核心总算暂时稳定。

### **4\. 仓促的收尾 (1.1Y, 1.1Z)**

最后，我们通过1\_1Y和1\_1Z补全了多人游戏的最后闭环：

* **退出保存（1\_1Y）**：修复了玩家退出时数据未保存的问题。
* **身份识别（1\_1Z）**：实现了playerName \-\> UUID的持久化映射，解决了玩家重连被视为新玩家（丢失存档）的致命问题。

## **Version 1.1 技术总结**

Version 1.1是一次**险胜**。我们**以极高的技术债务为代价**，强行完成了C/S架构的迁移。我们将V1.0一个结构清晰的“单体”，**异化**成了一个功能可用、但内部充满耦合和临时补丁的“C/S混合体”。

* **C/S 架构 (客户端/服务端)**:
    * 实现了彻底的职责分离，Server（权威逻辑）和Client（预测渲染）使用完全独立的类（ServerPlayer/ClientPlayer等）。
    * 确立了“服务端权威、客户端预测”的网络模型。
    * 实现了SharedWorld.isRemote()的“魔法开关”，优雅地解决了共享Block的逻辑分离。
* **网络协议栈**:
    * 确立了“JDK 21 虚拟线程 \+ 原生Socket \+ Kryo二进制序列化”的“黄金技术栈”。
    * 设计并实现了覆盖17种核心功能的C2S/S2C网络数据包。
* **引擎核心**:
    * 实现了基于Registry的方块注册表，为Mod奠定了基础。
    * 实现了“固定时间步长”（Fixed Timestep），将逻辑（TPS）与渲染（FPS）解耦。
    * 实现了“摄像机插值渲染”和精调的物理引擎（0.6f摩擦力）。
* **多人游戏管理**:
    * 实现了多玩家实体管理、状态广播和视口动态同步。
    * 实现了基于玩家名和UUID的持久化机制，支持玩家掉线重连。

V1.1的完成标志着MyCraft的底层架构**虽然功能上得以实现，但留下了巨大的隐患**。我们这支“Web后端团队”成功跨越了游戏开发中最陡峭的几个学习曲线，**但也留下了需要V1.2来“彻底净化”的战场**。

## **项目团队与鸣谢**

MyCraft 项目的成功离不开每一位团队成员的辛勤付出和智慧贡献。我们是一个充满激情、追求卓越的团队，共同将一个从零开始的想法构建成一个充满无限可能的体素世界。

### **核心团队成员**

* **项目经理 (Project Manager):** KspTooi
* **研发顾问 (R\&D Consultant):** Gemini 2.5 Pro
* **技术经理 (Technical Manager):** Grok4、Gemini 2.5 Pro
* **研发工程师 (R\&D Engineer):** Composer 1
* **研发工程师 (R\&D Engineer):** Sonnet 4.5
* **研发工程师 (R\&D Engineer):** Kimi K2
* **研发工程师 (R\&D Engineer):** Gemini 2.5 Flash
* **UI设计师 (UI Designer):** Imagen 4